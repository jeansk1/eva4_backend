{% extends 'base.html' %}

{% block title %}Reportes - TemucoSoft{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-end mb-4 gap-2">
    <div>
        <h6 class="text-uppercase text-muted small fw-bold ls-1">Business Intelligence</h6>
        <h2 class="fw-bold text-dark mb-0">Dashboard de Gestión</h2>
        <p class="text-muted small mb-0" id="fecha-actual">Cargando fecha...</p>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-shape bg-primary-subtle text-primary rounded-3 me-3">
                        <i class="bi bi-currency-dollar fs-4"></i>
                    </div>
                    <h6 class="text-muted text-uppercase fw-bold mb-0 small">Ventas Mes</h6>
                </div>
                <h3 class="fw-bold text-dark mb-1" id="totalVentas">Cargando...</h3>
                <small class="text-muted">Acumulado mes actual</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-shape bg-success-subtle text-success rounded-3 me-3">
                        <i class="bi bi-receipt fs-4"></i>
                    </div>
                    <h6 class="text-muted text-uppercase fw-bold mb-0 small">Transacciones</h6>
                </div>
                <h3 class="fw-bold text-dark mb-1" id="totalTransacciones">-</h3>
                <small class="text-muted">Operaciones realizadas</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-shape bg-warning-subtle text-warning rounded-3 me-3">
                        <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                    </div>
                    <h6 class="text-muted text-uppercase fw-bold mb-0 small">Alerta Stock</h6>
                </div>
                <h3 class="fw-bold text-dark mb-1" id="totalBajoStock">-</h3>
                <small class="text-muted">Productos críticos</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-shape bg-info-subtle text-info rounded-3 me-3">
                        <i class="bi bi-globe fs-4"></i>
                    </div>
                    <h6 class="text-muted text-uppercase fw-bold mb-0 small">E-commerce</h6>
                </div>
                <h3 class="fw-bold text-dark mb-1" id="totalOrdenes">-</h3>
                <small class="text-muted">Pedidos pendientes</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom-0">
                <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-graph-up me-2"></i>Ventas por Período</h5>
                <button class="btn btn-sm btn-light text-muted" onclick="exportarTablaCSV('tabla-ventas-resultado', 'ventas.csv')" title="Descargar CSV">
                    <i class="bi bi-download"></i>
                </button>
            </div>
            <div class="card-body bg-light-subtle">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label x-small fw-bold text-uppercase">Desde</label>
                        <input type="date" class="form-control form-control-sm border-0 shadow-none" id="fechaDesdeVentas">
                    </div>
                    <div class="col-6">
                        <label class="form-label x-small fw-bold text-uppercase">Hasta</label>
                        <input type="date" class="form-control form-control-sm border-0 shadow-none" id="fechaHastaVentas">
                    </div>
                    <div class="col-12 mt-2">
                        <button class="btn btn-primary w-100 btn-sm" onclick="generarReporteVentas()">
                            Actualizar Datos
                        </button>
                    </div>
                </div>
                <div id="resultadoVentas" class="bg-white rounded-3 shadow-sm border" style="height: 300px; overflow-y: auto;">
                    <div class="d-flex h-100 align-items-center justify-content-center text-muted small">
                        Seleccione un rango de fechas
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom-0">
                <h5 class="mb-0 fw-bold text-success"><i class="bi bi-box-seam me-2"></i>Estado de Inventario</h5>
                <button class="btn btn-sm btn-light text-muted" onclick="exportarTablaCSV('tabla-stock-resultado', 'stock.csv')" title="Descargar CSV">
                    <i class="bi bi-download"></i>
                </button>
            </div>
            <div class="card-body bg-light-subtle">
                <div class="mb-3">
                    <label class="form-label x-small fw-bold text-uppercase">Filtrar por Sucursal</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-shop"></i></span>
                        <select class="form-select border-0 shadow-none" id="sucursalStock">
                            <option value="">Todas las sucursales</option>
                        </select>
                        <button class="btn btn-success" onclick="generarReporteStock()">Consultar</button>
                    </div>
                </div>
                <div id="resultadoStock" class="bg-white rounded-3 shadow-sm border" style="height: 300px; overflow-y: auto;">
                     <div class="d-flex h-100 align-items-center justify-content-center text-muted small">
                        Consulte para ver detalles
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .ls-1 { letter-spacing: 1px; }
    .x-small { font-size: 0.7rem; }
    .bg-light-subtle { background-color: #f8f9fa; }
    
    .icon-shape {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .spinner-sm {
        width: 1.5rem;
        height: 1.5rem;
        border-width: 0.2em;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // =============================================================
    // VERIFICACIÓN DE PLAN DE SUSCRIPCIÓN (OBLIGATORIA)
    // =============================================================
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Verificar autenticación
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }

        // 2. Obtener información del usuario
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const rol = userInfo.rol;
        const plan = userInfo.plan ? userInfo.plan.toLowerCase() : 'basico';
        
        // 3. Verificar si tiene permiso para ver reportes
        // Reportes requieren: Rol Admin/Gerente + Plan Estándar o Premium
        // (SuperAdmin siempre puede)
        const isStandardOrHigher = plan === 'estandar' || plan === 'premium';
        const isSuperAdmin = rol === 'super_admin';
        const hasReportAccess = isSuperAdmin || 
                               (['admin_cliente', 'gerente'].includes(rol) && isStandardOrHigher);

        // 4. Si NO tiene acceso, mostrar mensaje y bloquear
        if (!hasReportAccess) {
            document.querySelector('.main-container').innerHTML = `
                <div class="row justify-content-center mt-5">
                    <div class="col-md-8 col-lg-6">
                        <div class="card border-0 shadow-lg text-center">
                            <div class="card-body p-5">
                                <div class="icon-shape bg-warning-subtle text-warning rounded-circle mx-auto mb-4" style="width: 80px; height: 80px;">
                                    <i class="bi bi-lock-fill fs-2"></i>
                                </div>
                                <h3 class="fw-bold text-dark mb-3">Función no disponible</h3>
                                <p class="text-muted mb-4">
                                    Los reportes avanzados requieren el <strong class="text-warning">Plan Estándar</strong> o superior.
                                </p>
                                
                                <div class="alert alert-warning border-0 bg-warning-subtle text-start mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill fs-5 me-3 text-warning"></i>
                                        <div>
                                            <strong>Tu plan actual: ${plan.toUpperCase()}</strong><br>
                                            <small class="text-muted">Actualiza tu suscripción para desbloquear reportes detallados, análisis de ventas y exportación de datos.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-3 justify-content-center">
                                    <a href="/" class="btn btn-primary">
                                        <i class="bi bi-arrow-left me-2"></i> Volver al inicio
                                    </a>
                                    <button class="btn btn-outline-warning" onclick="mostrarPlanes()">
                                        <i class="bi bi-gem me-2"></i> Ver planes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Función para mostrar planes
            window.mostrarPlanes = function() {
                alert('Aquí iría la página de planes de suscripción\n\nPlanes disponibles:\n\n• BÁSICO: POS e inventario básico\n• ESTÁNDAR: + Reportes avanzados\n• PREMIUM: + E-commerce y múltiples sucursales');
            };
            
            return; // Detener ejecución del resto del código
        }

        // 5. Si SÍ tiene acceso, continuar con el código normal
        // Mostrar badge del plan en el título
        const tituloPrincipal = document.querySelector('h2');
        if (tituloPrincipal && plan !== 'basico') {
            const badgeColor = plan === 'premium' ? 'bg-success' : 'bg-warning';
            tituloPrincipal.innerHTML = `Dashboard de Gestión <span class="badge ${badgeColor} ms-2">${plan.toUpperCase()}</span>`;
        }

        // =============================================================
        // CÓDIGO ORIGINAL DEL DASHBOARD DE REPORTES
        // =============================================================
        
        // Configuración de Fechas
        const hoy = new Date();
        const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        const fmtDate = d => d.toISOString().split('T')[0];
        
        const fechaStr = hoy.toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const elFecha = document.getElementById('fecha-actual');
        if(elFecha) elFecha.textContent = fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1);
        
        const inputDesde = document.getElementById('fechaDesdeVentas');
        const inputHasta = document.getElementById('fechaHastaVentas');
        
        if(inputDesde) inputDesde.value = fmtDate(primerDiaMes);
        if(inputHasta) inputHasta.value = fmtDate(hoy);

        cargarDatosIniciales();
    });

    // Función para cargar datos iniciales
    async function cargarDatosIniciales() {
        // Usamos la variable 'token' que viene de base.html
        try {
            // 1. Sucursales
            const resSuc = await fetch('/api/sucursales/', { headers: { 'Authorization': `Bearer ${token}` } });
            const sucursales = await resSuc.json();
            const select = document.getElementById('sucursalStock');
            if(select) {
                const listaSucursales = sucursales.results || sucursales;
                listaSucursales.forEach(s => 
                    select.innerHTML += `<option value="${s.id}">${s.nombre}</option>`
                );
            }

            // 2. Ventas Mes
            // CORRECCIÓN: Calcular fechas dentro de la función
            const hoy = new Date();
            const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const fmtDate = d => d.toISOString().split('T')[0];
            
            const resVentas = await fetch(`/api/ventas/?fecha_desde=${fmtDate(primerDiaMes)}&fecha_hasta=${fmtDate(hoy)}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const dataVentas = await resVentas.json();
            const listaVentas = dataVentas.results || dataVentas; 
            const totalMonto = listaVentas.reduce((sum, v) => sum + parseFloat(v.total || 0), 0);
            
            const elTotalVentas = document.getElementById('totalVentas');
            const elTotalTrans = document.getElementById('totalTransacciones');
            
            if(elTotalVentas) elTotalVentas.textContent = `$${totalMonto.toLocaleString('es-CL')}`;
            if(elTotalTrans) elTotalTrans.textContent = dataVentas.count || listaVentas.length;

            // 3. Stock
            try {
                const resStock = await fetch('/api/reportes/?tipo=stock', { headers: { 'Authorization': `Bearer ${token}` } });
                if (resStock.ok) {
                    const dataStock = await resStock.json();
                    if (dataStock.reporte_stock) {
                        const totalBajo = dataStock.reporte_stock.reduce((sum, s) => sum + (s.bajo_stock || 0), 0);
                        const totalAgotado = dataStock.reporte_stock.reduce((sum, s) => sum + (s.agotado || 0), 0);
                        const totalProblemas = totalBajo + totalAgotado;
                        
                        const elBajo = document.getElementById('totalBajoStock');
                        if(elBajo) {
                            elBajo.textContent = totalProblemas;
                            if(totalProblemas > 0) elBajo.classList.add('text-danger');
                        }
                    }
                }
            } catch (stockError) {
                console.log('Usando endpoint alternativo para stock');
                // Si falla, intentar con inventario básico
                const resInventario = await fetch('/api/inventario/', { headers: { 'Authorization': `Bearer ${token}` } });
                if (resInventario.ok) {
                    const inventarioData = await resInventario.json();
                    const listaInventario = inventarioData.results || inventarioData;
                    const bajoStock = listaInventario.filter(item => 
                        (item.stock || 0) <= (item.punto_reorden || 10)
                    ).length;
                    
                    const elBajo = document.getElementById('totalBajoStock');
                    if(elBajo) {
                        elBajo.textContent = bajoStock;
                        if(bajoStock > 0) elBajo.classList.add('text-danger');
                    }
                }
            }

            // 4. Ordenes
            try {
                const resOrdenes = await fetch('/api/ordenes/?estado=pendiente', { headers: { 'Authorization': `Bearer ${token}` } });
                if (resOrdenes.ok) {
                    const dataOrdenes = await resOrdenes.json();
                    const listaOrdenes = dataOrdenes.results || dataOrdenes;
                    const cantidad = listaOrdenes.length;
                    
                    const elOrdenes = document.getElementById('totalOrdenes');
                    if(elOrdenes) {
                        elOrdenes.textContent = cantidad;
                        if (cantidad > 0) {
                            elOrdenes.classList.add('text-warning');
                        }
                    }
                } else if (resOrdenes.status === 403) {
                    // No tiene plan premium
                    document.getElementById('totalOrdenes').textContent = 'Premium';
                    document.getElementById('totalOrdenes').classList.add('text-muted');
                }
            } catch (ordenError) {
                document.getElementById('totalOrdenes').textContent = '-';
            }

        } catch (error) { 
            console.error('Error cargando dashboard:', error);
            // Mostrar error amigable
            if (error.message.includes('403')) {
                document.getElementById('totalVentas').textContent = 'Sin acceso';
                document.getElementById('totalVentas').classList.add('text-muted');
            } else {
                document.getElementById('totalVentas').textContent = 'Error';
                document.getElementById('totalVentas').classList.add('text-danger');
            }
        }
    }

    async function generarReporteVentas() {
        const desde = document.getElementById('fechaDesdeVentas').value;
        const hasta = document.getElementById('fechaHastaVentas').value;
        const div = document.getElementById('resultadoVentas');

        div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center"><div class="spinner-border text-primary spinner-sm"></div></div>';

        try {
            const res = await fetch(`/api/ventas/?fecha_desde=${desde}&fecha_hasta=${hasta}`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            
            if (res.status === 403) {
                div.innerHTML = `
                    <div class="d-flex h-100 flex-column align-items-center justify-content-center text-center p-4">
                        <div class="icon-shape bg-warning-subtle text-warning rounded-circle mb-3" style="width: 60px; height: 60px;">
                            <i class="bi bi-lock fs-4"></i>
                        </div>
                        <p class="text-muted mb-0">No tienes permiso para acceder a estos datos.</p>
                        <small class="text-warning">Se requiere Plan Estándar o superior</small>
                    </div>
                `;
                return;
            }
            
            const data = await res.json();
            const ventas = data.results || data;

            if (ventas.length === 0) {
                div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-muted small">No hay datos</div>';
                return;
            }

            let html = `
                <table class="table table-sm table-hover mb-0 small" id="tabla-ventas-resultado">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Fecha</th>
                            <th>Sucursal</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalPeriodo = 0;
            ventas.forEach(v => {
                totalPeriodo += parseFloat(v.total || 0);
                html += `
                    <tr>
                        <td>${new Date(v.creado_en).toLocaleDateString('es-CL')}</td>
                        <td class="text-truncate" style="max-width: 120px;">${v.nombre_sucursal || 'Sin sucursal'}</td>
                        <td class="text-end fw-bold">$${parseFloat(v.total || 0).toLocaleString('es-CL')}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot class="table-light sticky-bottom border-top">
                        <tr>
                            <td colspan="2" class="text-end fw-bold text-secondary">TOTAL PERÍODO:</td>
                            <td class="text-end fw-bold text-primary fs-6">$${totalPeriodo.toLocaleString('es-CL')}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            div.innerHTML = html;

        } catch (error) { 
            console.error('Error generando reporte:', error);
            div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-danger small">Error al cargar datos</div>';
        }
    }

    async function generarReporteStock() {
        const sucursalId = document.getElementById('sucursalStock').value;
        const div = document.getElementById('resultadoStock');
        div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center"><div class="spinner-border text-success spinner-sm"></div></div>';

        let url = '/api/inventario/';
        if (sucursalId) url += `?sucursal=${sucursalId}`;

        try {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            
            if (res.status === 403) {
                div.innerHTML = `
                    <div class="d-flex h-100 flex-column align-items-center justify-content-center text-center p-4">
                        <div class="icon-shape bg-warning-subtle text-warning rounded-circle mb-3" style="width: 60px; height: 60px;">
                            <i class="bi bi-lock fs-4"></i>
                        </div>
                        <p class="text-muted mb-0">No tienes permiso para acceder a estos datos.</p>
                        <small class="text-warning">Se requiere Plan Estándar o superior</small>
                    </div>
                `;
                return;
            }
            
            const items = await res.json();
            const lista = items.results || items;

            if (lista.length === 0) {
                div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-muted small">No hay datos</div>';
                return;
            }

            let html = `
                <table class="table table-sm table-striped mb-0 small" id="tabla-stock-resultado">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>Producto</th>
                            <th class="text-center">Cant.</th>
                            <th class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            lista.forEach(i => {
                let badgeClass = 'bg-success-subtle text-success';
                let texto = 'OK';
                if (i.stock === 0) { badgeClass = 'bg-danger-subtle text-danger'; texto = 'AGOTADO'; }
                else if (i.stock <= i.punto_reorden) { badgeClass = 'bg-warning-subtle text-warning'; texto = 'BAJO'; }

                const nomProd = i.nombre_producto || `Prod ${i.producto}`;

                html += `
                    <tr>
                        <td class="text-truncate" style="max-width: 150px;" title="${nomProd}">${nomProd}</td>
                        <td class="text-center fw-bold">${i.stock || 0}</td>
                        <td class="text-center"><span class="badge ${badgeClass} border border-0">${texto}</span></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            div.innerHTML = html;

        } catch (error) { 
            console.error('Error generando stock:', error);
            div.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-danger small">Error al cargar datos</div>';
        }
    }

    function exportarTablaCSV(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) return alert("Genere el reporte primero.");
        
        let csv = [];
        const rows = table.querySelectorAll("tr");
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) row.push('"' + cols[j].innerText + '"');
            csv.push(row.join(","));
        }
        const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
        const link = document.createElement("a");
        link.download = filename;
        link.href = window.URL.createObjectURL(csvFile);
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
    }

    // Helper function para formatear fechas
    function fmtDate(d) {
        return d.toISOString().split('T')[0];
    }
</script>
{% endblock %}