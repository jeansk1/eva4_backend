{% extends 'base.html' %}

{% block title %}Ficha de Proveedor - TemucoSoft{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/proveedores/" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-arrow-left me-1"></i> Volver a Proveedores
        </a>
    </div>

    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <p class="mt-2 text-muted small fw-bold text-uppercase ls-1">Cargando ficha...</p>
    </div>

    <div id="proveedor-content" class="d-none animate-fade-in">
        <div class="row g-4">
            
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <div class="avatar-circle bg-success-subtle text-success mb-3 mx-auto">
                                <i class="bi bi-building fs-1"></i>
                            </div>
                            <h3 class="fw-bold text-dark mb-1" id="prov-nombre">-</h3>
                            <span class="badge bg-light text-secondary border" id="prov-rut">RUT: -</span>
                        </div>

                        <hr class="text-muted opacity-25">

                        <div class="vstack gap-3">
                            <div>
                                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Contacto Principal</small>
                                <div class="d-flex align-items-center mt-1">
                                    <i class="bi bi-person-circle me-2 text-secondary"></i>
                                    <span class="fw-medium text-dark" id="prov-contacto">-</span>
                                </div>
                            </div>

                            <div>
                                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Canales de Comunicación</small>
                                <div class="d-flex align-items-center mt-1 mb-1">
                                    <i class="bi bi-telephone me-2 text-secondary"></i>
                                    <span id="prov-telefono">-</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope me-2 text-secondary"></i>
                                    <a id="prov-email-link" href="#" class="text-decoration-none text-primary text-truncate">-</a>
                                </div>
                            </div>

                            <div>
                                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Dirección Comercial</small>
                                <div class="d-flex mt-1">
                                    <i class="bi bi-geo-alt me-2 text-secondary"></i>
                                    <p class="mb-0 text-secondary small" id="prov-direccion">-</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-top text-center">
                            <small class="text-muted" style="font-size: 0.75rem;">Registrado el: <span id="prov-fecha">-</span></small>
                        </div>
                        
                        <div class="mt-3 text-center">
                             <button class="btn btn-sm btn-outline-danger w-100" onclick="eliminarProveedor()">
                                <i class="bi bi-trash me-1"></i> Eliminar Proveedor
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold text-secondary"><i class="bi bi-clock-history me-2"></i>Historial de Abastecimiento</h6>
                        <span class="badge bg-success-subtle text-success border border-success-subtle">Últimas Compras</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Fecha</th>
                                        <th>N° Factura</th>
                                        <th>Resumen Items</th>
                                        <th class="text-end pe-4">Monto Total</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-historial">
                                    <tr><td colspan="4" class="text-center py-5"><div class="spinner-border spinner-border-sm text-secondary"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="msg-sin-compras" class="text-center py-5 d-none">
                            <div class="text-muted opacity-50 mb-2"><i class="bi bi-receipt display-4"></i></div>
                            <p class="text-muted mb-0">No se han registrado compras a este proveedor.</p>
                            <a href="/inventario/movimientos/" class="btn btn-sm btn-primary mt-3">Registrar Primera Compra</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-msg" class="alert alert-danger d-none text-center mt-4 border-0 shadow-sm">
        <i class="bi bi-exclamation-circle-fill me-2"></i> No se encontró el proveedor solicitado.
    </div>
</div>

<style>
    .ls-1 { letter-spacing: 1px; }
    .bg-success-subtle { background-color: #d1e7dd; }
    
    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block scripts %}
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const proveedorId = urlParams.get('id');

    document.addEventListener('DOMContentLoaded', async () => {
        if (!proveedorId) {
            window.location.href = '/proveedores/';
            return;
        }

        try {
            await cargarDatosProveedor();
            await cargarHistorialCompras(); 
        } catch (error) {
            console.error(error);
            document.getElementById('loading-spinner').classList.add('d-none');
            document.getElementById('error-msg').classList.remove('d-none');
        }
    });

    async function cargarDatosProveedor() {
        const token = localStorage.getItem('access_token');
        const res = await fetch(`/api/proveedores/${proveedorId}/`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Proveedor no encontrado');
        
        const p = await res.json();

        // Render
        document.getElementById('prov-nombre').textContent = p.nombre;
        document.getElementById('prov-rut').textContent = `RUT: ${p.rut}`;
        document.getElementById('prov-contacto').textContent = p.contacto;
        document.getElementById('prov-telefono').textContent = p.telefono;
        
        const emailLink = document.getElementById('prov-email-link');
        emailLink.textContent = p.email;
        emailLink.href = `mailto:${p.email}`;
        
        document.getElementById('prov-direccion').textContent = p.direccion;
        
        const dateOpts = { year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('prov-fecha').textContent = new Date(p.creado_en).toLocaleDateString('es-CL', dateOpts);

        document.getElementById('loading-spinner').classList.add('d-none');
        document.getElementById('proveedor-content').classList.remove('d-none');
    }

    async function cargarHistorialCompras() {
        const token = localStorage.getItem('access_token');
        // Optimization: In a real app, you'd use a filter endpoint like /api/compras/?proveedor=ID
        // For now, we filter in JS as per the backend capabilities
        const res = await fetch('/api/compras/', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const compras = data.results || data;
        
        const historial = compras.filter(c => c.proveedor == proveedorId);
        
        const tbody = document.getElementById('tabla-historial');
        tbody.innerHTML = '';

        if (historial.length === 0) {
            document.getElementById('msg-sin-compras').classList.remove('d-none');
            return;
        }

        historial.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        const ultimas = historial.slice(0, 5);

        ultimas.forEach(c => {
            const itemCount = c.items ? c.items.length : 0;
            tbody.innerHTML += `
                <tr>
                    <td class="ps-4">${new Date(c.fecha).toLocaleDateString('es-CL')}</td>
                    <td><span class="font-monospace text-secondary small bg-light px-2 py-1 rounded border">${c.numero_factura}</span></td>
                    <td><small class="text-muted">${itemCount} items registrados</small></td>
                    <td class="text-end pe-4 fw-bold text-success">$${parseFloat(c.total).toLocaleString('es-CL')}</td>
                </tr>
            `;
        });
    }

    async function eliminarProveedor() {
        if (confirm('¿Está seguro de eliminar este proveedor? \nSi tiene compras asociadas, el sistema no lo permitirá.')) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/proveedores/${proveedorId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert('Proveedor eliminado.');
                    window.location.href = '/proveedores/';
                } else {
                    alert('No se puede eliminar: Es probable que tenga historial de compras asociado.');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
    }
</script>
{% endblock %}