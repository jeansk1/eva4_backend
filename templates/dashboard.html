{% extends 'base.html' %}

{% block title %}Inicio - TemucoSoft{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-end mb-5">
    <div>
        <h6 class="text-uppercase text-muted small fw-bold ls-1">Panel de Control</h6>
        <h1 class="fw-bold text-dark display-5">Hola, <span id="welcome-name" class="text-primary">Usuario</span> 游녦</h1>
        <p class="text-muted mb-0">Bienvenido al sistema de gesti칩n integral.</p>
    </div>
    <div class="text-end d-none d-md-block">
        <p class="mb-0 fw-bold text-dark" id="current-date">Cargando fecha...</p>
        <span class="badge bg-light text-secondary border" id="user-role-badge">Rol</span>
    </div>
</div>

<div class="row g-4">
    
    <div class="col-md-6 col-lg-3" id="card-ventas">
        <a href="/ventas/" class="card h-100 border-0 shadow-hover text-decoration-none module-card">
            <div class="card-body p-4">
                <div class="icon-shape bg-success-subtle text-success rounded-3 mb-3">
                    <i class="bi bi-cart-check-fill fs-3"></i>
                </div>
                <h5 class="fw-bold text-dark">Punto de Venta</h5>
                <p class="text-muted small mb-0">Realizar ventas, emitir tickets y gestionar caja diaria.</p>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0 pb-4">
                <span class="text-success fw-bold small">Ir al POS <i class="bi bi-arrow-right ms-1"></i></span>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3" id="card-productos">
        <a href="/productos/" class="card h-100 border-0 shadow-hover text-decoration-none module-card">
            <div class="card-body p-4">
                <div class="icon-shape bg-primary-subtle text-primary rounded-3 mb-3">
                    <i class="bi bi-box-seam-fill fs-3"></i>
                </div>
                <h5 class="fw-bold text-dark">Productos</h5>
                <p class="text-muted small mb-0">Gesti칩n de cat치logo, precios, costos y categor칤as.</p>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0 pb-4">
                <span class="text-primary fw-bold small">Ver Cat치logo <i class="bi bi-arrow-right ms-1"></i></span>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3" id="card-inventario">
        <a href="/inventario/" class="card h-100 border-0 shadow-hover text-decoration-none module-card">
            <div class="card-body p-4">
                <div class="icon-shape bg-warning-subtle text-warning rounded-3 mb-3">
                    <i class="bi bi-boxes fs-3"></i>
                </div>
                <h5 class="fw-bold text-dark">Inventario</h5>
                <p class="text-muted small mb-0">Control de stock, ingresos de mercader칤a y ajustes.</p>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0 pb-4">
                <span class="text-warning fw-bold small">Gestionar Stock <i class="bi bi-arrow-right ms-1"></i></span>
            </div>
        </a>
    </div>

    <div class="col-md-6 col-lg-3" id="card-reportes">
        <a href="/reportes/" class="card h-100 border-0 shadow-hover text-decoration-none module-card">
            <div class="card-body p-4">
                <div class="icon-shape bg-info-subtle text-info rounded-3 mb-3">
                    <i class="bi bi-graph-up-arrow fs-3"></i>
                </div>
                <h5 class="fw-bold text-dark">Reportes</h5>
                <p class="text-muted small mb-0">KPIs, gr치ficos de rendimiento y exportaci칩n de datos.</p>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0 pb-4">
                <span class="text-info fw-bold small">Ver Estad칤sticas <i class="bi bi-arrow-right ms-1"></i></span>
            </div>
        </a>
    </div>

</div>

<div class="row mt-5" id="admin-section" style="display: none;">
    <div class="col-12 mb-3">
        <h6 class="text-uppercase text-muted small fw-bold border-bottom pb-2">Administraci칩n</h6>
    </div>
    <div class="col-md-6 mb-3">
        <a href="/usuarios/" class="d-flex align-items-center p-3 bg-white rounded shadow-sm text-decoration-none text-dark hover-bg-light">
            <i class="bi bi-people-fill fs-4 text-secondary me-3"></i>
            <div>
                <h6 class="mb-0 fw-bold">Usuarios</h6>
                <small class="text-muted">Gestionar personal</small>
            </div>
        </a>
    </div>
    <div class="col-md-6 mb-3">
        <a href="/sucursales/" class="d-flex align-items-center p-3 bg-white rounded shadow-sm text-decoration-none text-dark hover-bg-light">
            <i class="bi bi-building fs-4 text-secondary me-3"></i>
            <div>
                <h6 class="mb-0 fw-bold">Sucursales</h6>
                <small class="text-muted">Gestionar tiendas</small>
            </div>
        </a>
    </div>
</div>

<style>
    /* Custom Styles for Dashboard */
    .ls-1 { letter-spacing: 1px; }
    
    .icon-shape {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .shadow-hover {
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .shadow-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
    }

    .hover-bg-light:hover {
        background-color: #f8f9fa !important;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Cargar Datos del Usuario
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const rol = userInfo.rol;
        const plan = userInfo.plan ? userInfo.plan.toLowerCase() : 'basico';
        const companiaNombre = userInfo.compania || 'Compa침칤a';
        
        // Detectar niveles de plan
        const isStandardOrHigher = plan === 'estandar' || plan === 'premium';
        const isPremium = plan === 'premium';
        const isBasic = plan === 'basico';

        // Personalizar saludo
        if (userInfo.username) {
            // Capitalizar primera letra
            const name = userInfo.username.charAt(0).toUpperCase() + userInfo.username.slice(1);
            document.getElementById('welcome-name').textContent = name;
            
            // Mostrar Rol Y PLAN con colores
            const rolMap = {
                'super_admin': 'Super Admin',
                'admin_cliente': 'Administrador',
                'gerente': 'Gerente',
                'vendedor': 'Vendedor'
            };
            const rolText = rolMap[rol] || rol;
            
            // Asignar color seg칰n plan
            let planColor = 'bg-secondary';
            if (plan === 'premium') planColor = 'bg-success';
            else if (plan === 'estandar') planColor = 'bg-warning text-dark';
            else if (plan === 'basico') planColor = 'bg-primary';
            
            document.getElementById('user-role-badge').innerHTML = `
                <span class="fw-bold">${rolText}</span> 췅 
                <span class="${planColor} text-white px-2 py-1 rounded">${plan.toUpperCase()}</span>
            `;
        }

        // Mostrar Fecha Actual
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const fecha = new Date().toLocaleDateString('es-CL', options);
        document.getElementById('current-date').textContent = fecha.charAt(0).toUpperCase() + fecha.slice(1);

        // =============================================================
        // 2. CARGAR ESTAD칈STICAS DEL PLAN Y SUCURSALES
        // =============================================================
        if (rol !== 'super_admin' && rol !== 'vendedor') {
            await cargarEstadisticasPlan(rol, plan, companiaNombre);
        }

        // =============================================================
        // 3. L칍GICA COMBINADA: ROL + PLAN DE SUSCRIPCI칍N
        // =============================================================
        
        // A. Para Vendedores (rol espec칤fico)
        if (rol === 'vendedor') {
            document.getElementById('card-productos').style.display = 'none';
            document.getElementById('card-inventario').style.display = 'none';
            document.getElementById('card-reportes').style.display = 'none';
            
            // Ajustar grid para que el POS se vea bien solo
            document.getElementById('card-ventas').classList.remove('col-md-6', 'col-lg-3');
            document.getElementById('card-ventas').classList.add('col-md-12', 'col-lg-4');
        }

        // B. Verificaci칩n por PLAN para Reportes
        if (!isStandardOrHigher && rol !== 'super_admin') {
            const cardReportes = document.getElementById('card-reportes');
            if (cardReportes) {
                cardReportes.innerHTML = `
                    <div class="card h-100 border-0 bg-light text-muted position-relative">
                        <div class="card-body p-4">
                            <div class="icon-shape bg-secondary-subtle text-secondary rounded-3 mb-3">
                                <i class="bi bi-graph-up-arrow fs-3"></i>
                            </div>
                            <h5 class="fw-bold text-secondary">Reportes <span class="badge bg-warning ms-2">Est치ndar+</span></h5>
                            <p class="text-muted small mb-2">KPIs, gr치ficos de rendimiento y exportaci칩n de datos.</p>
                            <div class="mt-3">
                                <span class="badge bg-warning text-dark small">
                                    <i class="bi bi-lock me-1"></i> Requiere Plan Est치ndar
                                </span>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 pt-0 pb-4">
                            <span class="text-secondary fw-bold small">Bloqueado por plan</span>
                        </div>
                    </div>
                `;
            }
        } else if (isStandardOrHigher && rol !== 'vendedor') {
            // Si tiene acceso, mostrar badge
            const cardReportes = document.getElementById('card-reportes');
            if (cardReportes) {
                const title = cardReportes.querySelector('h5');
                if (title) {
                    title.innerHTML = `Reportes <span class="badge ${isPremium ? 'bg-success' : 'bg-warning'} ms-2">${isPremium ? 'Premium' : 'Est치ndar+'}</span>`;
                }
            }
        }

        // C. Administraci칩n (solo para plan Premium o SuperAdmin)
        const adminSection = document.getElementById('admin-section');
        if (adminSection) {
            // SuperAdmin siempre ve todo
            if (rol === 'super_admin') {
                adminSection.style.display = 'flex';
                // Agregar badge a los enlaces de admin
                document.querySelectorAll('#admin-section h6').forEach(title => {
                    if (title.textContent.includes('Usuarios') || title.textContent.includes('Sucursales')) {
                        title.innerHTML = `${title.textContent} <span class="badge bg-dark ms-2">SuperAdmin</span>`;
                    }
                });
            }
            // AdminCliente solo ve administraci칩n si tiene plan Premium
            else if (rol === 'admin_cliente' && isPremium) {
                adminSection.style.display = 'flex';
                // Agregar badge Premium
                document.querySelectorAll('#admin-section h6').forEach(title => {
                    if (title.textContent.includes('Usuarios') || title.textContent.includes('Sucursales')) {
                        title.innerHTML = `${title.textContent} <span class="badge bg-success ms-2">Premium</span>`;
                    }
                });
            } else if (rol === 'admin_cliente' && !isPremium) {
                // Mostrar secci칩n de admin pero deshabilitada
                adminSection.style.display = 'flex';
                adminSection.classList.add('opacity-50');
                adminSection.querySelectorAll('a').forEach(link => {
                    link.classList.remove('hover-bg-light');
                    link.classList.add('disabled');
                    link.onclick = (e) => {
                        e.preventDefault();
                        mostrarAlertaPlan();
                    };
                    
                    // Agregar badge "Premium" a los t칤tulos
                    const title = link.querySelector('h6');
                    if (title) {
                        title.innerHTML = `${title.textContent} <span class="badge bg-success ms-2">Premium</span>`;
                    }
                });
            } else {
                adminSection.style.display = 'none';
            }
        }

        // D. Mostrar alerta informativa sobre el plan
        if (rol !== 'super_admin' && isBasic) {
            setTimeout(() => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-4 border-0';
                alertDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="icon-shape bg-warning-subtle text-warning rounded-3 me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-info-circle fs-4"></i>
                        </div>
                        <div class="flex-grow-1">
                            <strong>Plan B치sico Activo</strong>
                            <p class="mb-0 small">Tienes acceso a funcionalidades b치sicas. Actualiza tu plan para desbloquear:</p>
                            <div class="row mt-2 g-2">
                                <div class="col-auto">
                                    <span class="badge bg-warning text-dark"><i class="bi bi-graph-up me-1"></i> Reportes Avanzados</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-success text-white"><i class="bi bi-shop me-1"></i> M칰ltiples Sucursales</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-info text-white"><i class="bi bi-globe me-1"></i> E-commerce</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('.row.g-4').parentNode.insertBefore(alertDiv, document.querySelector('.row.g-4').nextSibling);
            }, 1000);
        }

        // E. Cargar estad칤sticas r치pidas
        if (rol !== 'vendedor') {
            await cargarEstadisticasRapidas();
        }
    });

    // =============================================================
    // FUNCIONES AUXILIARES
    // =============================================================

    async function cargarEstadisticasPlan(rol, plan, companiaNombre) {
        try {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            // 1. Cargar sucursales actuales
            const resSucursales = await fetch('/api/sucursales/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!resSucursales.ok) return;

            const dataSucursales = await resSucursales.json();
            const sucursales = dataSucursales.results || dataSucursales;
            const totalSucursales = sucursales.length;
            
            // 2. Definir l칤mites seg칰n plan
            const limitesPorPlan = {
                'basico': 1,
                'estandar': 3,
                'premium': 9999
            };
            const limiteSucursales = limitesPorPlan[plan] || 1;
            
            // 3. Crear card de estad칤sticas del plan
            const cardPlan = document.createElement('div');
            cardPlan.className = 'card border-0 shadow-sm mb-4';
            
            let headerClass = 'bg-primary text-white';
            let iconClass = 'bi-info-circle';
            let headerText = 'Plan B치sico';
            
            if (plan === 'premium') {
                headerClass = 'bg-success text-white';
                iconClass = 'bi-gem';
                headerText = 'Plan Premium';
            } else if (plan === 'estandar') {
                headerClass = 'bg-warning text-dark';
                iconClass = 'bi-star-fill';
                headerText = 'Plan Est치ndar';
            }
            
            const porcentajeUso = Math.min(Math.round((totalSucursales / limiteSucursales) * 100), 100);
            const barraColor = plan === 'premium' ? 'bg-success' : 
                             porcentajeUso >= 80 ? 'bg-warning' : 'bg-primary';
            
            let contenidoCard = `
                <div class="card-header ${headerClass} border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold"><i class="bi ${iconClass} me-2"></i> ${headerText}</h6>
                        <span class="badge bg-white ${plan === 'premium' ? 'text-success' : plan === 'estandar' ? 'text-warning' : 'text-primary'}">
                            ${companiaNombre}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-shape ${plan === 'premium' ? 'bg-success-subtle text-success' : plan === 'estandar' ? 'bg-warning-subtle text-warning' : 'bg-primary-subtle text-primary'} rounded-3 me-3">
                                    <i class="bi bi-shop-window fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold">${totalSucursales} ${plan === 'premium' ? 'Sucursales' : `/${limiteSucursales}`}</h5>
                                    <small class="text-muted">
                                        ${plan === 'premium' ? '<i class="bi bi-infinity text-success me-1"></i> Ilimitadas' : 
                                         plan === 'estandar' ? `${limiteSucursales - totalSucursales} disponibles` : 
                                         'Sucursal principal'}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
            `;
            
            if (plan !== 'premium') {
                contenidoCard += `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">L칤mite de sucursales</small>
                                    <small class="fw-bold">${porcentajeUso}%</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar ${barraColor}" role="progressbar" style="width: ${porcentajeUso}%"></div>
                                </div>
                            </div>
                `;
                
                if (porcentajeUso >= 80) {
                    contenidoCard += `
                            <div class="alert ${plan === 'estandar' ? 'alert-warning' : 'alert-primary'} border-0 ${plan === 'estandar' ? 'bg-warning-subtle' : 'bg-primary-subtle'} small py-2 mb-0">
                                <i class="bi ${porcentajeUso >= 100 ? 'bi-exclamation-triangle-fill' : 'bi-exclamation-triangle'} me-1"></i> 
                                ${porcentajeUso >= 100 ? 'L칤mite alcanzado' : 'Pr칩ximo al l칤mite'}
                            </div>
                    `;
                }
            } else {
                contenidoCard += `
                            <div class="alert alert-success border-0 bg-success-subtle small py-2 mb-0">
                                <i class="bi bi-check-circle-fill me-1"></i> Acceso completo activado
                            </div>
                `;
            }
            
            contenidoCard += `
                        </div>
                    </div>
                </div>
            `;
            
            cardPlan.innerHTML = contenidoCard;
            
            // Insertar despu칠s del t칤tulo principal
            const tituloPrincipal = document.querySelector('.d-flex.justify-content-between.align-items-end.mb-5');
            if (tituloPrincipal) {
                tituloPrincipal.parentNode.insertBefore(cardPlan, tituloPrincipal.nextElementSibling);
            }
            
        } catch (error) {
            console.error('Error cargando estad칤sticas del plan:', error);
        }
    }

    async function cargarEstadisticasRapidas() {
        try {
            const token = localStorage.getItem('access_token');
            const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
            const rol = userInfo.rol;
            const plan = userInfo.plan ? userInfo.plan.toLowerCase() : 'basico';
            
            // Solo para roles con permisos
            if (rol === 'vendedor') return;
            
            // Cargar estad칤sticas de ventas del mes
            const hoy = new Date();
            const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const fmtDate = d => d.toISOString().split('T')[0];
            
            const resVentas = await fetch(`/api/ventas/?fecha_desde=${fmtDate(primerDiaMes)}&fecha_hasta=${fmtDate(hoy)}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (resVentas.ok) {
                const dataVentas = await resVentas.json();
                const ventas = dataVentas.results || dataVentas;
                const totalMes = ventas.reduce((sum, v) => sum + parseFloat(v.total), 0);
                
                // Crear mini-card de estad칤sticas
                if (totalMes > 0 && document.querySelector('.row.g-4')) {
                    const statsDiv = document.createElement('div');
                    statsDiv.className = 'row mt-4';
                    statsDiv.innerHTML = `
                        <div class="col-12">
                            <div class="card border-0 bg-light-subtle">
                                <div class="card-body p-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-shape bg-success-subtle text-success rounded-3 me-3">
                                                    <i class="bi bi-currency-dollar fs-4"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold text-dark">Ventas del Mes</h6>
                                                    <h4 class="mb-0 fw-bold text-success">$${totalMes.toLocaleString('es-CL')}</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <h6 class="mb-0 fw-bold text-dark">Transacciones</h6>
                                                <h4 class="mb-0 fw-bold text-primary">${ventas.length}</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <h6 class="mb-0 fw-bold text-dark">Ticket Promedio</h6>
                                                <h4 class="mb-0 fw-bold text-warning">$${ventas.length > 0 ? Math.round(totalMes / ventas.length).toLocaleString('es-CL') : '0'}</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.querySelector('.row.g-4').parentNode.insertBefore(statsDiv, document.querySelector('.row.g-4').nextElementSibling);
                }
            }
            
        } catch (error) {
            console.error('Error cargando estad칤sticas r치pidas:', error);
        }
    }

    function mostrarAlertaPlan() {
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const plan = userInfo.plan ? userInfo.plan.toLowerCase() : 'basico';
        
        const alertHTML = `
            <div class="alert alert-info border-0 alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3 shadow-lg" style="z-index: 1060; max-width: 500px;">
                <div class="d-flex align-items-center">
                    <div class="icon-shape bg-info-subtle text-info rounded-3 me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-gem fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong>Funci칩n Premium</strong>
                        <p class="mb-0 small">Esta funcionalidad requiere el Plan Premium. Tu plan actual: <span class="fw-bold text-uppercase">${plan}</span></p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            </div>
        `;
        
        const alertDiv = document.createElement('div');
        alertDiv.innerHTML = alertHTML;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}