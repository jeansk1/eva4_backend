{% extends 'base.html' %}

{% block title %}Detalle de Sucursal - TemucoSoft{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/sucursales/" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="bi bi-arrow-left me-1"></i> Volver a Sucursales
        </a>
    </div>

    <div id="loading-spinner" class="text-center py-5">
        <div class="spinner-border text-info" role="status"></div>
        <p class="mt-2 text-muted small fw-bold text-uppercase ls-1">Cargando información...</p>
    </div>

    <div id="sucursal-content" class="d-none animate-fade-in">
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <div class="avatar-circle bg-info-subtle text-info mb-3">
                                    <i class="bi bi-shop-window fs-2"></i>
                                </div>
                                <h3 class="fw-bold text-dark mb-1" id="suc-nombre">-</h3>
                                <span class="badge bg-light text-secondary border" id="suc-id">ID: -</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu shadow-sm border-0">
                                    <li><button class="dropdown-item text-danger" onclick="eliminarSucursal()"><i class="bi bi-trash me-2"></i>Eliminar</button></li>
                                </ul>
                            </div>
                        </div>

                        <hr class="text-muted opacity-25">

                        <div class="vstack gap-3">
                            <div>
                                <small class="text-uppercase text-muted fw-bold x-small">Contacto</small>
                                <div class="d-flex align-items-center mt-1 mb-1">
                                    <i class="bi bi-telephone me-2 text-secondary"></i>
                                    <span class="fw-medium text-dark" id="suc-telefono">-</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-envelope me-2 text-secondary"></i>
                                    <a id="suc-email" href="#" class="text-decoration-none text-primary text-truncate">-</a>
                                </div>
                            </div>

                            <div>
                                <small class="text-uppercase text-muted fw-bold x-small">Ubicación</small>
                                <div class="d-flex mt-1">
                                    <i class="bi bi-geo-alt me-2 text-secondary"></i>
                                    <p class="mb-0 text-secondary small" id="suc-direccion">-</p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-3 border-top">
                            <a id="btn-ver-inventario" href="#" class="btn btn-info w-100 shadow-sm text-white">
                                <i class="bi bi-boxes me-2"></i> Ver Inventario Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold text-primary"><i class="bi bi-speedometer2 me-2"></i>Estado de Bodega</h6>
                        <span class="badge bg-primary-subtle text-primary border border-primary-subtle">Resumen</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row text-center mb-4 g-3">
                            <div class="col-6">
                                <div class="p-3 bg-light rounded-3 border">
                                    <h2 class="fw-bold text-dark mb-0" id="kpi-total-items">-</h2>
                                    <small class="text-muted x-small text-uppercase fw-bold">Productos Únicos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-warning-subtle rounded-3 border border-warning-subtle">
                                    <h2 class="fw-bold text-warning-emphasis mb-0" id="kpi-bajo-stock">-</h2>
                                    <small class="text-warning-emphasis x-small text-uppercase fw-bold">Alertas Stock</small>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-uppercase text-muted x-small fw-bold mb-3 border-bottom pb-2">Top 5 Stock</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0 align-middle">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-3 text-secondary x-small text-uppercase">Producto</th>
                                        <th class="text-center text-secondary x-small text-uppercase">Stock</th>
                                        <th class="text-center text-secondary x-small text-uppercase">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-resumen-stock">
                                    <tr><td colspan="3" class="text-center py-3 text-muted small">Calculando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-msg" class="alert alert-danger d-none text-center mt-4 shadow-sm border-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> No se encontró la sucursal.
    </div>
</div>

<style>
    .ls-1 { letter-spacing: 1px; }
    .x-small { font-size: 0.7rem; }
    .bg-info-subtle { background-color: #cff4fc; }
    .bg-warning-subtle { background-color: #fff3cd; }
    .text-warning-emphasis { color: #664d03; }

    .avatar-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
{% endblock %}

{% block scripts %}
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const sucursalId = urlParams.get('id');

    document.addEventListener('DOMContentLoaded', async () => {
        if (!sucursalId) {
            window.location.href = '/sucursales/';
            return;
        }

        try {
            await cargarDatosSucursal();
            await cargarResumenInventario();
        } catch (error) {
            console.error(error);
            document.getElementById('loading-spinner').classList.add('d-none');
            document.getElementById('error-msg').classList.remove('d-none');
        }
    });

    async function cargarDatosSucursal() {
        const token = localStorage.getItem('access_token');
        const res = await fetch(`/api/sucursales/${sucursalId}/`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Sucursal no encontrada');
        
        const s = await res.json();

        // Render
        document.getElementById('suc-nombre').textContent = s.nombre;
        document.getElementById('suc-id').textContent = '#' + s.id;
        document.getElementById('suc-telefono').textContent = s.telefono;
        
        const emailLink = document.getElementById('suc-email');
        emailLink.textContent = s.email;
        emailLink.href = `mailto:${s.email}`;
        
        document.getElementById('suc-direccion').textContent = s.direccion;
        document.getElementById('btn-ver-inventario').href = `/inventario/?sucursal=${s.id}`;

        document.getElementById('loading-spinner').classList.add('d-none');
        document.getElementById('sucursal-content').classList.remove('d-none');
    }

    async function cargarResumenInventario() {
        const token = localStorage.getItem('access_token');
        const res = await fetch(`/api/inventario/?sucursal=${sucursalId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const items = await res.json();
        const lista = items.results || items;
        
        // KPIs
        const totalItems = lista.length;
        const bajoStock = lista.filter(i => i.stock <= i.punto_reorden).length;

        document.getElementById('kpi-total-items').textContent = totalItems;
        document.getElementById('kpi-bajo-stock').textContent = bajoStock;

        const tbody = document.getElementById('tabla-resumen-stock');
        tbody.innerHTML = '';

        if (lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted small py-4">Bodega vacía.</td></tr>';
            return;
        }

        lista.sort((a, b) => b.stock - a.stock);
        const topItems = lista.slice(0, 5);

        topItems.forEach(i => {
            let badgeClass = 'bg-success-subtle text-success';
            let texto = 'OK';
            if (i.stock === 0) { badgeClass = 'bg-danger-subtle text-danger'; texto = 'AGOTADO'; }
            else if (i.stock <= i.punto_reorden) { badgeClass = 'bg-warning-subtle text-warning-emphasis'; texto = 'BAJO'; }

            // Safe name handling
            const nomProd = i.nombre_producto || `ID ${i.producto}`;

            tbody.innerHTML += `
                <tr>
                    <td class="ps-3 fw-medium text-dark">${nomProd}</td>
                    <td class="text-center fw-bold">${i.stock}</td>
                    <td class="text-center"><span class="badge ${badgeClass} border border-0 rounded-pill" style="font-size: 0.65rem;">${texto}</span></td>
                </tr>
            `;
        });
    }

    async function eliminarSucursal() {
        if (confirm('¿Está seguro de eliminar esta sucursal? \nADVERTENCIA: Si tiene ventas o inventario asociado, no se podrá eliminar.')) {
            const token = localStorage.getItem('access_token');
            try {
                const res = await fetch(`/api/sucursales/${sucursalId}/`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    alert('Sucursal eliminada.');
                    window.location.href = '/sucursales/';
                } else {
                    alert('No se puede eliminar: Probablemente tiene registros asociados (Inventario/Ventas).');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
    }
</script>
{% endblock %}