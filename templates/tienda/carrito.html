<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - TemucoSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .navbar-brand { font-weight: 700; color: #0d6efd !important; }
        .checkout-sidebar { position: sticky; top: 20px; }
        .alert-stock-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .item-overstock { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Notificaciones */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-5">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/tienda/">
                <i class="bi bi-box-seam-fill me-2"></i>TemucoSoft Store
            </a>
            <div class="ms-auto">
                <a href="/tienda/" class="text-decoration-none text-secondary small fw-bold">
                    <i class="bi bi-arrow-left me-1"></i> Volver a la tienda
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row g-5">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 fw-bold">Tu Carrito <span class="badge bg-primary rounded-pill ms-2" id="cart-count-badge">0</span></h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="vaciarCarrito()" id="btn-vaciar" disabled>
                        <i class="bi bi-trash"></i> Vaciar Todo
                    </button>
                </div>

                <!-- Estado -->
                <div id="status-message" class="alert alert-info d-none mb-3 fade-in">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="status-text">Cargando...</span>
                </div>

                <div class="card border-0 shadow-sm mb-5 overflow-hidden">
                    <div class="card-body p-0">
                        <div id="cart-items-container">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <div id="checkout-form-section" class="d-none fade-in">
                    <h4 class="mb-3 fw-bold">Datos de Despacho</h4>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <form id="order-form" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Nombre Completo <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="cliente_nombre" required placeholder="Ej: Juan P√©rez">
                                        <div class="invalid-feedback">Por favor ingresa tu nombre</div>
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="cliente_email" required placeholder="correo@ejemplo.com">
                                        <div class="invalid-feedback">Por favor ingresa un email v√°lido</div>
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Tel√©fono <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="cliente_telefono" required placeholder="+56 9 1234 5678">
                                        <div class="invalid-feedback">Por favor ingresa tu tel√©fono</div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Direcci√≥n de Env√≠o <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="cliente_direccion" rows="3" required placeholder="Calle, N√∫mero, Depto, Comuna, Regi√≥n"></textarea>
                                        <div class="invalid-feedback">Por favor ingresa tu direcci√≥n</div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="terminos" required>
                                            <label class="form-check-label small" for="terminos">
                                                Acepto los <a href="#" class="text-decoration-none">t√©rminos y condiciones</a> de compra
                                            </label>
                                            <div class="invalid-feedback">Debes aceptar los t√©rminos y condiciones</div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="checkout-sidebar">
                    <div class="card border-0 shadow-sm bg-white">
                        <div class="card-header bg-light py-3 border-bottom">
                            <h5 class="mb-0 fw-bold text-dark">Resumen del Pedido</h5>
                        </div>
                        <div class="card-body p-4">
                            <div id="stock-warning" class="alert alert-warning d-none mb-3 py-2 small fade-in">
                                <i class="bi bi-exclamation-triangle me-1"></i> 
                                <span id="stock-error-details">Verificando stock...</span>
                            </div>

                            <ul class="list-unstyled mb-4">
                                <li class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Subtotal</span>
                                    <strong id="summary-subtotal">$0</strong>
                                </li>
                                <li class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Env√≠o</span>
                                    <span class="text-success fw-bold">Gratis</span>
                                </li>
                                <li class="d-flex justify-content-between mb-3 border-top pt-2">
                                    <span class="text-muted">Productos</span>
                                    <span id="summary-items-count">0</span>
                                </li>
                                <li class="d-flex justify-content-between border-top pt-3">
                                    <span class="fs-5 fw-bold">Total</span>
                                    <span class="fs-4 fw-bold text-primary" id="summary-total">$0</span>
                                </li>
                            </ul>

                            <button class="btn btn-success w-100 btn-lg py-3 fw-bold shadow-sm mb-3" onclick="procesarPago()" id="btn-pagar" disabled>
                                <i class="bi bi-credit-card me-2"></i> Confirmar y Pagar
                            </button>
                            
                            <p class="text-center text-muted small mb-0">
                                <i class="bi bi-shield-check text-success me-1"></i>
                                Pago 100% seguro
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // CONFIGURACI√ìN GLOBAL
        // ============================================
        const API_BASE_URL = '/api';
        let cart = [];
        let inventarioGlobal = {};
        
        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================
        
        // Obtener CSRF Token de cookies
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    console.log('üîê CSRF Token encontrado');
                    return value;
                }
            }
            console.warn('‚ö†Ô∏è CSRF token no encontrado');
            return null;
        }
        
        // Configuraci√≥n din√°mica para fetch
        function getFetchConfig(method = 'GET', data = null) {
            const config = {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                }
            };
            
            // Para m√©todos que modifican datos, agregar CSRF token
            if (method !== 'GET') {
                const csrfToken = getCSRFToken();
                if (csrfToken) {
                    config.headers['X-CSRFToken'] = csrfToken;
                    console.log('üîê Enviando CSRF token para m√©todo', method);
                }
            }
            
            if (method !== 'GET' && data !== null) {
                config.method = method;
                config.body = JSON.stringify(data);
            }
            
            return config;
        }
        
        // Mostrar notificaci√≥n toast
        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Remover notificaciones anteriores
            document.querySelectorAll('.notification-toast').forEach(n => n.remove());
            
            const toast = document.createElement('div');
            toast.className = `alert alert-${tipo} notification-toast shadow-lg`;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi ${tipo === 'success' ? 'bi-check-circle-fill' : 
                                  tipo === 'error' ? 'bi-exclamation-triangle-fill' : 
                                  tipo === 'warning' ? 'bi-exclamation-triangle-fill' : 
                                  'bi-info-circle-fill'} me-2"></i>
                    <span class="flex-grow-1">${mensaje}</span>
                    <button type="button" class="btn-close btn-sm" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Mostrar estado en el carrito
        function mostrarEstado(mensaje, tipo = 'info') {
            const statusEl = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');
            
            if (!statusEl || !statusText) return;
            
            statusText.textContent = mensaje;
            statusEl.className = `alert alert-${tipo} d-flex align-items-center fade-in`;
            statusEl.classList.remove('d-none');
            
            if (tipo === 'success') {
                setTimeout(() => statusEl.classList.add('d-none'), 3000);
            }
        }
        
        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando aplicaci√≥n del carrito...');
            mostrarEstado('Cargando tu carrito...', 'info');
            await inicializarCarrito();
        });
        
        // ============================================
        // FUNCI√ìN PRINCIPAL
        // ============================================
        async function inicializarCarrito() {
            try {
                console.log('üç™ Verificando cookies...');
                console.log('Cookies actuales:', document.cookie);
                
                // Cargar inventario
                await cargarInventarioStock();
                
                // Cargar carrito
                await cargarCarritoDesdeAPI();
                
                // Configurar listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                mostrarEstado('Error al cargar el carrito', 'danger');
                mostrarNotificacion('Error al cargar el carrito', 'error');
            }
        }
        
        // ============================================
        // CARGAR INVENTARIO
        // ============================================
        async function cargarInventarioStock() {
            try {
                console.log('üì¶ Cargando inventario...');
                const res = await fetch(`${API_BASE_URL}/inventario/`, getFetchConfig());
                
                if (res.ok) {
                    const data = await res.json();
                    const listaInventario = data.results || data;
                    
                    inventarioGlobal = {};
                    listaInventario.forEach(item => {
                        const stock = parseInt(item.stock) || 0;
                        const prodId = item.producto;
                        inventarioGlobal[prodId] = (inventarioGlobal[prodId] || 0) + stock;
                    });
                    
                    console.log(`‚úÖ Inventario cargado: ${Object.keys(inventarioGlobal).length} productos`);
                    return true;
                }
                return false;
            } catch(e) {
                console.error("‚ùå Error inventario:", e);
                return false;
            }
        }
        
        // ============================================
        // CARGAR CARRITO DESDE API
        // ============================================
        async function cargarCarritoDesdeAPI() {
            try {
                console.log('üîç Solicitando carrito...');
                const res = await fetch(`${API_BASE_URL}/carrito/`, getFetchConfig());
                
                console.log('üìä Respuesta:', res.status, res.statusText);
                
                if (res.ok) {
                    const data = await res.json();
                    console.log('üì¶ Datos recibidos:', data);
                    
                    const items = data.results || data;
                    
                    if (items.length === 0) {
                        mostrarEstado('Tu carrito est√° vac√≠o', 'info');
                        cart = [];
                        renderizarItems();
                        return;
                    }
                    
                    // Procesar items
                    cart = items.map(item => {
                        const producto = item.producto || {};
                        return {
                            carrito_id: item.id,
                            producto_id: producto.id || producto,
                            nombre: producto.nombre || 'Producto',
                            precio: parseFloat(producto.precio) || 0,
                            cantidad: item.cantidad || 1,
                            stock_disponible: inventarioGlobal[producto.id || producto] || 0,
                            imagen: producto.imagen || null
                        };
                    });
                    
                    console.log(`‚úÖ Carrito cargado: ${cart.length} items`);
                    mostrarEstado(`Carrito cargado (${cart.length} productos)`, 'success');
                    renderizarItems();
                    actualizarResumen();
                    
                } else if (res.status === 404 || res.status === 204) {
                    // Carrito vac√≠o
                    cart = [];
                    mostrarEstado('Tu carrito est√° vac√≠o', 'info');
                    renderizarItems();
                } else {
                    const errorText = await res.text();
                    console.error('‚ùå Error API:', res.status, errorText);
                    mostrarEstado(`Error ${res.status}: No se pudo cargar el carrito`, 'danger');
                }
            } catch (e) {
                console.error('‚ùå Error conexi√≥n:', e);
                mostrarEstado('Error de conexi√≥n con el servidor', 'danger');
            }
        }
        
        // ============================================
        // RENDERIZAR ITEMS
        // ============================================
        function renderizarItems() {
            const container = document.getElementById('cart-items-container');
            const checkoutSection = document.getElementById('checkout-form-section');
            const btnVaciar = document.getElementById('btn-vaciar');
            
            if (!container) return;
            
            if (!cart || cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <i class="bi bi-cart-x fs-1 text-secondary opacity-50"></i>
                        </div>
                        <h5 class="text-dark fw-bold mb-3">Tu carrito est√° vac√≠o</h5>
                        <p class="text-muted mb-4">Agrega productos desde la tienda.</p>
                        <a href="/tienda/" class="btn btn-primary px-4 rounded-pill">
                            <i class="bi bi-arrow-left me-2"></i> Ir a la Tienda
                        </a>
                    </div>
                `;
                if (checkoutSection) checkoutSection.classList.add('d-none');
                if (btnVaciar) btnVaciar.disabled = true;
                if (document.getElementById('cart-count-badge')) {
                    document.getElementById('cart-count-badge').textContent = '0';
                }
                if (document.getElementById('btn-pagar')) {
                    document.getElementById('btn-pagar').disabled = true;
                }
                return;
            }
            
            // Mostrar contenido
            if (checkoutSection) checkoutSection.classList.remove('d-none');
            if (btnVaciar) btnVaciar.disabled = false;
            if (document.getElementById('cart-count-badge')) {
                document.getElementById('cart-count-badge').textContent = cart.length;
            }
            
            let html = '<ul class="list-group list-group-flush">';
            let hayErrorStock = false;
            
            cart.forEach(item => {
                const stockSuficiente = item.stock_disponible >= item.cantidad;
                const subtotal = item.precio * item.cantidad;
                
                if (!stockSuficiente) hayErrorStock = true;
                
                html += `
                    <li class="list-group-item py-3 fade-in ${!stockSuficiente ? 'item-overstock' : ''}">
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="d-flex align-items-start">
                                    <div class="bg-light rounded p-2 me-3 flex-shrink-0" style="width: 60px; height: 60px;">
                                        ${item.imagen ? 
                                            `<img src="${item.imagen}" class="img-fluid" alt="${item.nombre}" style="width: 100%; height: 100%; object-fit: contain;">` :
                                            `<i class="bi bi-box-seam fs-4 ${!stockSuficiente ? 'text-warning' : 'text-secondary'} d-flex align-items-center justify-content-center h-100"></i>`
                                        }
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold text-dark">${item.nombre}</h6>
                                        <p class="text-muted small mb-1">$${item.precio.toLocaleString('es-CL')} c/u</p>
                                        <p class="small ${!stockSuficiente ? 'text-danger' : 'text-success'} mb-0">
                                            <i class="bi ${!stockSuficiente ? 'bi-exclamation-triangle' : 'bi-check-circle'} me-1"></i>
                                            Stock: ${item.stock_disponible} unidades
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.carrito_id}, -1, ${item.producto_id})" ${item.cantidad <= 1 ? 'disabled' : ''}>
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="text" class="form-control text-center" value="${item.cantidad}" readonly>
                                    <button class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.carrito_id}, 1, ${item.producto_id})" ${!stockSuficiente && item.cantidad >= item.stock_disponible ? 'disabled' : ''}>
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 text-end">
                                <span class="fw-bold d-block fs-5">$${subtotal.toLocaleString('es-CL')}</span>
                                <button class="btn btn-sm btn-link text-danger p-0" onclick="eliminarItem(${item.carrito_id})">
                                    <i class="bi bi-trash me-1"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            container.innerHTML = html;
            
            // Actualizar estado de stock
            verificarStockGlobal(hayErrorStock);
        }
        
        // ============================================
        // ACTUALIZAR CANTIDAD
        // ============================================
        async function actualizarCantidad(carritoId, cambio, productoId) {
            const itemIndex = cart.findIndex(item => item.carrito_id === carritoId);
            if (itemIndex === -1) return;
            
            const item = cart[itemIndex];
            const stockDisponible = inventarioGlobal[productoId] || 0;
            const nuevaCantidad = item.cantidad + cambio;
            
            if (nuevaCantidad < 1) {
                await eliminarItem(carritoId);
                return;
            }
            
            if (nuevaCantidad > stockDisponible) {
                mostrarEstado(`Stock m√°ximo: ${stockDisponible} unidades`, 'warning');
                mostrarNotificacion(`Stock m√°ximo: ${stockDisponible} unidades`, 'warning');
                return;
            }
            
            try {
                const config = getFetchConfig('PATCH', { cantidad: nuevaCantidad });
                console.log(`üîÑ Actualizando cantidad: ${item.carrito_id} a ${nuevaCantidad}`);
                
                const res = await fetch(`${API_BASE_URL}/carrito/${carritoId}/`, config);
                
                if (res.ok) {
                    item.cantidad = nuevaCantidad;
                    item.stock_disponible = stockDisponible;
                    renderizarItems();
                    actualizarResumen();
                    mostrarEstado('Cantidad actualizada', 'success');
                    mostrarNotificacion('Cantidad actualizada', 'success');
                } else {
                    const error = await res.json();
                    console.error('‚ùå Error actualizando:', error);
                    mostrarEstado('Error al actualizar cantidad', 'danger');
                    mostrarNotificacion('Error al actualizar cantidad', 'error');
                }
            } catch (e) {
                console.error('‚ùå Error actualizando:', e);
                mostrarEstado('Error de conexi√≥n', 'danger');
                mostrarNotificacion('Error de conexi√≥n', 'error');
            }
        }
        
        // ============================================
        // ELIMINAR ITEM
        // ============================================
        async function eliminarItem(carritoId) {
            if (!confirm('¬øEliminar este producto del carrito?')) return;
            
            try {
                const config = getFetchConfig('DELETE');
                console.log(`üóëÔ∏è Eliminando item: ${carritoId}`);
                
                const res = await fetch(`${API_BASE_URL}/carrito/${carritoId}/`, config);
                
                if (res.ok) {
                    cart = cart.filter(item => item.carrito_id !== carritoId);
                    renderizarItems();
                    actualizarResumen();
                    mostrarEstado('Producto eliminado', 'success');
                    mostrarNotificacion('Producto eliminado del carrito', 'success');
                } else {
                    const error = await res.json();
                    console.error('‚ùå Error eliminando:', error);
                    mostrarEstado('Error al eliminar producto', 'danger');
                    mostrarNotificacion('Error al eliminar producto', 'error');
                }
            } catch (e) {
                console.error('‚ùå Error eliminando:', e);
                mostrarEstado('Error de conexi√≥n', 'danger');
                mostrarNotificacion('Error de conexi√≥n', 'error');
            }
        }
        
        // ============================================
        // VACIAR CARRITO
        // ============================================
        async function vaciarCarrito() {
            if (cart.length === 0) return;
            
            if (!confirm(`¬øVaciar todo el carrito? (${cart.length} productos)`)) return;
            
            try {
                const config = getFetchConfig('DELETE');
                console.log(`üóëÔ∏è Vaciando carrito completo`);
                
                const res = await fetch(`${API_BASE_URL}/carrito/`, config);
                
                if (res.ok) {
                    cart = [];
                    renderizarItems();
                    actualizarResumen();
                    mostrarEstado('Carrito vaciado', 'success');
                    mostrarNotificacion('Carrito vaciado', 'success');
                } else {
                    const error = await res.json();
                    console.error('‚ùå Error vaciando:', error);
                    mostrarEstado('Error al vaciar carrito', 'danger');
                    mostrarNotificacion('Error al vaciar carrito', 'error');
                }
            } catch (e) {
                console.error('‚ùå Error vaciando:', e);
                mostrarEstado('Error de conexi√≥n', 'danger');
                mostrarNotificacion('Error de conexi√≥n', 'error');
            }
        }
        
        // ============================================
        // ACTUALIZAR RESUMEN
        // ============================================
        function actualizarResumen() {
            if (cart.length === 0) {
                document.getElementById('summary-subtotal').textContent = '$0';
                document.getElementById('summary-total').textContent = '$0';
                document.getElementById('summary-items-count').textContent = '0';
                if (document.getElementById('btn-pagar')) {
                    document.getElementById('btn-pagar').disabled = true;
                }
                return;
            }
            
            const totalItems = cart.reduce((sum, item) => sum + item.cantidad, 0);
            const subtotal = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            document.getElementById('summary-subtotal').textContent = '$' + subtotal.toLocaleString('es-CL');
            document.getElementById('summary-total').textContent = '$' + subtotal.toLocaleString('es-CL');
            document.getElementById('summary-items-count').textContent = totalItems + (totalItems !== 1 ? ' productos' : ' producto');
            
            // Verificar si se puede pagar
            const puedePagar = cart.every(item => item.cantidad <= item.stock_disponible);
            if (document.getElementById('btn-pagar')) {
                document.getElementById('btn-pagar').disabled = !puedePagar;
            }
        }
        
        // ============================================
        // VERIFICAR STOCK
        // ============================================
        function verificarStockGlobal(hayError = false) {
            const stockWarning = document.getElementById('stock-warning');
            const stockErrorDetails = document.getElementById('stock-error-details');
            const btnPagar = document.getElementById('btn-pagar');
            
            if (!stockWarning || !stockErrorDetails || !btnPagar) return;
            
            if (cart.length === 0) {
                stockWarning.classList.add('d-none');
                btnPagar.disabled = true;
                return;
            }
            
            if (hayError === false) {
                hayError = cart.some(item => item.cantidad > item.stock_disponible);
            }
            
            if (hayError) {
                stockWarning.classList.remove('d-none');
                const productosSinStock = cart.filter(item => item.cantidad > item.stock_disponible);
                
                if (productosSinStock.length === 1) {
                    stockErrorDetails.textContent = `${productosSinStock[0].nombre} excede stock`;
                } else {
                    stockErrorDetails.textContent = `${productosSinStock.length} productos exceden stock`;
                }
                
                btnPagar.disabled = true;
                btnPagar.innerHTML = '<i class="bi bi-x-circle me-2"></i> Stock Insuficiente';
                btnPagar.classList.remove('btn-success');
                btnPagar.classList.add('btn-danger');
            } else {
                stockWarning.classList.add('d-none');
                if (btnPagar) {
                    btnPagar.disabled = false;
                    btnPagar.innerHTML = '<i class="bi bi-credit-card me-2"></i> Confirmar y Pagar';
                    btnPagar.classList.remove('btn-danger');
                    btnPagar.classList.add('btn-success');
                }
            }
        }
        
        // ============================================
        // SETUP LISTENERS
        // ============================================
        function setupEventListeners() {
            // Validaci√≥n formulario
            const inputs = document.querySelectorAll('#order-form input, #order-form textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    if (input.checkValidity()) {
                        input.classList.remove('is-invalid');
                        input.classList.add('is-valid');
                    } else {
                        input.classList.remove('is-valid');
                        input.classList.add('is-invalid');
                    }
                });
            });
            
            // T√©rminos y condiciones
            const terminos = document.getElementById('terminos');
            if (terminos) {
                terminos.addEventListener('change', () => {
                    const btnPagar = document.getElementById('btn-pagar');
                    if (btnPagar) {
                        btnPagar.disabled = !terminos.checked;
                    }
                });
            }
        }
        
        // ============================================
        // PROCESAR PAGO
        // ============================================
        async function procesarPago() {
            if (cart.length === 0) return;
            
            // Validar stock
            for (let item of cart) {
                if (item.cantidad > item.stock_disponible) {
                    mostrarEstado(`Stock insuficiente para ${item.nombre}`, 'danger');
                    mostrarNotificacion(`Stock insuficiente para ${item.nombre}`, 'error');
                    return;
                }
            }
            
            // Validar formulario
            const form = document.getElementById('order-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const btnPagar = document.getElementById('btn-pagar');
            const originalText = btnPagar.innerHTML;
            btnPagar.disabled = true;
            btnPagar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Procesando...';
            
            // Preparar datos
            const total = cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const orderData = {
                nombre_cliente: document.getElementById('cliente_nombre').value.trim(),
                email_cliente: document.getElementById('cliente_email').value.trim(),
                telefono_cliente: document.getElementById('cliente_telefono').value.trim(),
                direccion_cliente: document.getElementById('cliente_direccion').value.trim(),
                total: total,
                estado: 'pendiente',
                items: cart.map(item => ({
                    producto: item.producto_id,
                    cantidad: item.cantidad,
                    precio_unitario: item.precio
                }))
            };
            
            try {
                const config = getFetchConfig('POST', orderData);
                console.log('üí∞ Procesando pago...', orderData);
                
                const res = await fetch(`${API_BASE_URL}/ordenes/`, config);
                
                if (res.ok) {
                    const orden = await res.json();
                    console.log('‚úÖ Orden creada:', orden);
                    
                    // Vaciar carrito
                    await vaciarCarrito();
                    
                    mostrarNotificacion('‚úÖ ¬°Orden creada exitosamente! Redirigiendo...', 'success');
                    
                    // Redirigir
                    setTimeout(() => {
                        window.location.href = `/tienda/confirmacion/?id=${orden.id}`;
                    }, 2000);
                    
                } else {
                    const error = await res.json();
                    console.error('‚ùå Error creando orden:', error);
                    mostrarEstado('Error: ' + (error.detail || JSON.stringify(error)), 'danger');
                    mostrarNotificacion('Error al crear la orden', 'error');
                    btnPagar.disabled = false;
                    btnPagar.innerHTML = originalText;
                }
            } catch (e) {
                console.error('‚ùå Error:', e);
                mostrarEstado('Error de conexi√≥n', 'danger');
                mostrarNotificacion('Error de conexi√≥n', 'error');
                btnPagar.disabled = false;
                btnPagar.innerHTML = originalText;
            }
        }
        
        // ============================================
        // FUNCIONES DE DEBUG
        // ============================================
        window.debugCarrito = function() {
            console.log('üîß DEBUG CARRITO');
            console.log('Cart:', cart);
            console.log('Inventario:', inventarioGlobal);
            console.log('CSRF Token:', getCSRFToken());
        };
        
        // Forzar recarga del carrito
        window.recargarCarrito = async function() {
            console.log('üîÑ Recargando carrito...');
            mostrarEstado('Recargando carrito...', 'info');
            await cargarCarritoDesdeAPI();
        };
        
    </script>
</body>
</html>