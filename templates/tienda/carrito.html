<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - TemucoSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .navbar-brand { font-weight: 700; color: #0d6efd !important; }
        .checkout-sidebar { position: sticky; top: 20px; }
        .alert-stock-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .item-overstock { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .notification-toast { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Eliminar flechas del input number para diseño limpio */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-5">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/tienda/">
                <i class="bi bi-box-seam-fill me-2"></i>TemucoSoft Store
            </a>
            <div class="ms-auto">
                <a href="/tienda/" class="text-decoration-none text-secondary small fw-bold">
                    <i class="bi bi-arrow-left me-1"></i> Volver a la tienda
                </a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row g-5">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 fw-bold">Tu Carrito <span class="badge bg-primary rounded-pill ms-2" id="cart-count-badge">0</span></h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="vaciarCarrito()" id="btn-vaciar" disabled>
                        <i class="bi bi-trash"></i> Vaciar Todo
                    </button>
                </div>

                <div id="status-message" class="alert alert-info d-none mb-3 fade-in">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="status-text">Cargando...</span>
                </div>

                <div class="card border-0 shadow-sm mb-5 overflow-hidden">
                    <div class="card-body p-0">
                        <div id="cart-items-container">
                            </div>
                    </div>
                </div>

                <div id="checkout-form-section" class="d-none fade-in">
                    <h4 class="mb-3 fw-bold">Datos de Despacho</h4>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-4">
                            <form id="order-form" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Nombre Completo <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="cliente_nombre" required placeholder="Ej: Juan Pérez">
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="cliente_email" required placeholder="correo@ejemplo.com">
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Teléfono <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="cliente_telefono" required placeholder="+56 9 1234 5678">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small fw-bold text-uppercase text-secondary">Dirección de Envío <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="cliente_direccion" rows="3" required placeholder="Calle, Número, Depto, Comuna, Región"></textarea>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="terminos" required>
                                            <label class="form-check-label small" for="terminos">
                                                Acepto los <a href="#" class="text-decoration-none">términos y condiciones</a> de compra
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="checkout-sidebar">
                    <div class="card border-0 shadow-sm bg-white">
                        <div class="card-header bg-light py-3 border-bottom">
                            <h5 class="mb-0 fw-bold text-dark">Resumen del Pedido</h5>
                        </div>
                        <div class="card-body p-4">
                            <div id="stock-warning" class="alert alert-warning d-none mb-3 py-2 small fade-in">
                                <i class="bi bi-exclamation-triangle me-1"></i> 
                                <span id="stock-error-details">Verificando stock...</span>
                            </div>

                            <ul class="list-unstyled mb-4">
                                <li class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Subtotal</span>
                                    <strong id="summary-subtotal">$0</strong>
                                </li>
                                <li class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Envío</span>
                                    <span class="text-success fw-bold">Gratis</span>
                                </li>
                                <li class="d-flex justify-content-between mb-3 border-top pt-2">
                                    <span class="text-muted">Productos</span>
                                    <span id="summary-items-count">0</span>
                                </li>
                                <li class="d-flex justify-content-between border-top pt-3">
                                    <span class="fs-5 fw-bold">Total</span>
                                    <span class="fs-4 fw-bold text-primary" id="summary-total">$0</span>
                                </li>
                            </ul>

                            <button class="btn btn-success w-100 btn-lg py-3 fw-bold shadow-sm mb-3" onclick="procesarPago()" id="btn-pagar" disabled>
                                <i class="bi bi-credit-card me-2"></i> Confirmar y Pagar
                            </button>
                            
                            <p class="text-center text-muted small mb-0">
                                <i class="bi bi-shield-check text-success me-1"></i>
                                Pago 100% seguro
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = '/api';
        let cart = [];
        let inventarioGlobal = {};

        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return value;
            }
            return null;
        }

        function getFetchConfig(method = 'GET', data = null) {
            const config = {
                credentials: 'include',
                headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
            };
            if (method !== 'GET') {
                const csrfToken = getCSRFToken();
                if (csrfToken) config.headers['X-CSRFToken'] = csrfToken;
                config.method = method;
                if (data !== null) config.body = JSON.stringify(data);
            }
            return config;
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${tipo} notification-toast shadow-lg`;
            toast.innerHTML = `<div class="d-flex align-items-center"><span class="flex-grow-1">${mensaje}</span><button type="button" class="btn-close btn-sm" onclick="this.parentElement.parentElement.remove()"></button></div>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function mostrarEstado(mensaje, tipo = 'info') {
            const statusEl = document.getElementById('status-message');
            const statusText = document.getElementById('status-text');
            if (!statusEl) return;
            statusText.textContent = mensaje;
            statusEl.className = `alert alert-${tipo} d-flex align-items-center fade-in`;
            statusEl.classList.remove('d-none');
            if (tipo === 'success') setTimeout(() => statusEl.classList.add('d-none'), 3000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarInventarioStock();
            await cargarCarritoDesdeAPI();
            setupEventListeners();
        });

        async function cargarInventarioStock() {
            try {
                const res = await fetch(`${API_BASE_URL}/inventario/`, getFetchConfig());
                if (res.ok) {
                    const data = await res.json();
                    const lista = data.results || data;
                    inventarioGlobal = {};
                    lista.forEach(item => {
                        const pId = parseInt(item.producto);
                        const stock = parseInt(item.stock);
                        if (!isNaN(pId) && !isNaN(stock)) {
                            inventarioGlobal[pId] = (inventarioGlobal[pId] || 0) + stock;
                        }
                    });
                }
            } catch(e) { console.error("Error inventario", e); }
        }

        async function cargarCarritoDesdeAPI() {
            try {
                const res = await fetch(`${API_BASE_URL}/carrito/`, getFetchConfig());
                if (res.ok) {
                    const data = await res.json();
                    const items = data.results || data;
                    
                    if (items.length === 0) {
                        cart = [];
                        renderizarItems();
                        return;
                    }

                    cart = items.map(item => {
                        const prodId = item.producto_id || item.producto; 
                        
                        let precioRaw = item.precio_producto;
                        if (precioRaw === undefined || precioRaw === null) {
                            precioRaw = item.precio; 
                        }
                        const precioFinal = parseFloat(precioRaw) || 0;

                        const nombreFinal = item.nombre_producto || item.nombre || 'Producto';
                        const imagenFinal = item.imagen_producto || item.imagen || null;

                        return {
                            carrito_id: item.id,
                            producto_id: parseInt(prodId),
                            nombre: nombreFinal,
                            precio: precioFinal, 
                            cantidad: parseInt(item.cantidad) || 1,
                            stock_disponible: inventarioGlobal[parseInt(prodId)] || 0,
                            imagen: imagenFinal
                        };
                    });
                    
                    renderizarItems();
                    actualizarResumen();
                    mostrarEstado(`Carrito cargado (${cart.length} productos)`, 'success');
                } else if (res.status === 404) {
                    cart = [];
                    renderizarItems();
                }
            } catch (e) {
                console.error(e);
                mostrarEstado('Error de conexión al cargar carrito', 'danger');
            }
        }

        function renderizarItems() {
            const container = document.getElementById('cart-items-container');
            const checkoutSection = document.getElementById('checkout-form-section');
            const btnVaciar = document.getElementById('btn-vaciar');

            if (!cart || cart.length === 0) {
                container.innerHTML = `<div class="text-center py-5"><h5 class="text-muted">Tu carrito está vacío</h5><a href="/tienda/" class="btn btn-primary mt-3">Ir a la Tienda</a></div>`;
                if(checkoutSection) checkoutSection.classList.add('d-none');
                if(btnVaciar) btnVaciar.disabled = true;
                document.getElementById('cart-count-badge').textContent = '0';
                actualizarResumen(); 
                return;
            }

            if(checkoutSection) checkoutSection.classList.remove('d-none');
            if(btnVaciar) btnVaciar.disabled = false;
            document.getElementById('cart-count-badge').textContent = cart.length;

            let html = '<ul class="list-group list-group-flush">';
            let hayErrorStock = false;

            cart.forEach(item => {
                const stockSuficiente = item.stock_disponible >= item.cantidad;
                const subtotal = (item.precio || 0) * (item.cantidad || 1);
                
                if (!stockSuficiente) hayErrorStock = true;

                const imagenHtml = item.imagen 
                    ? `<img src="${item.imagen}" class="img-fluid" style="width: 100%; height: 100%; object-fit: contain;">`
                    : `<div class="d-flex align-items-center justify-content-center h-100 bg-secondary text-white"><i class="bi bi-camera-video-off"></i></div>`;

                // --- AQUÍ ESTÁ EL CAMBIO DEL INPUT MANUAL ---
                html += `
                    <li class="list-group-item py-3 ${!stockSuficiente ? 'item-overstock' : ''}">
                        <div class="row align-items-center">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div class="d-flex align-items-start">
                                    <div class="bg-light rounded p-2 me-3 flex-shrink-0" style="width: 60px; height: 60px; overflow:hidden;">
                                        ${imagenHtml}
                                    </div>
                                    <div>
                                        <h6 class="mb-1 fw-bold">${item.nombre}</h6>
                                        <p class="text-muted small mb-1">$${item.precio.toLocaleString('es-CL')}</p>
                                        <p class="small ${!stockSuficiente ? 'text-danger' : 'text-success'} mb-0">
                                            Stock: ${item.stock_disponible}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.carrito_id}, -1)">-</button>
                                    
                                    <input type="number" class="form-control text-center p-0" 
                                           value="${item.cantidad}" 
                                           min="1" 
                                           max="${item.stock_disponible}"
                                           onchange="cambiarCantidadManual(this, ${item.carrito_id}, ${item.stock_disponible})"
                                           onkeypress="return event.charCode >= 48 && event.charCode <= 57">
                                    
                                    <button class="btn btn-outline-secondary" onclick="actualizarCantidad(${item.carrito_id}, 1)" ${!stockSuficiente ? 'disabled' : ''}>+</button>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 text-end">
                                <span class="fw-bold d-block">$${subtotal.toLocaleString('es-CL')}</span>
                                <button class="btn btn-sm btn-link text-danger p-0" onclick="eliminarItem(${item.carrito_id})">Eliminar</button>
                            </div>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
            verificarStockGlobal(hayErrorStock);
        }

        // --- NUEVA FUNCIÓN: VALIDAR Y ENVIAR CAMBIO MANUAL ---
        async function cambiarCantidadManual(input, carritoId, stockMax) {
            let nuevaCantidad = parseInt(input.value);

            // Validar que sea un número positivo
            if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
                nuevaCantidad = 1;
                input.value = 1; // Corregir visualmente
            }

            // Validar contra Stock Máximo
            if (nuevaCantidad > stockMax) {
                mostrarNotificacion(`Solo hay ${stockMax} unidades disponibles`, 'warning');
                nuevaCantidad = stockMax;
                input.value = stockMax; // Corregir visualmente
            }

            // Enviar a la API
            await enviarActualizacionAPI(carritoId, nuevaCantidad);
        }

        async function actualizarCantidad(carritoId, cambio) {
            const item = cart.find(i => i.carrito_id === carritoId);
            if (!item) return;
            
            const nuevaCantidad = item.cantidad + cambio;
            
            if (nuevaCantidad < 1) { eliminarItem(carritoId); return; }
            if (nuevaCantidad > item.stock_disponible) { 
                mostrarNotificacion('Stock máximo alcanzado', 'warning'); 
                return; 
            }

            await enviarActualizacionAPI(carritoId, nuevaCantidad);
        }

        // Función Centralizada para contactar a la API
        async function enviarActualizacionAPI(carritoId, cantidadFinal) {
            // Feedback visual rápido
            const item = cart.find(i => i.carrito_id === carritoId);
            if(item) item.cantidad = cantidadFinal; 
            actualizarResumen();

            try {
                const res = await fetch(`${API_BASE_URL}/carrito/${carritoId}/`, getFetchConfig('PATCH', { cantidad: cantidadFinal }));
                if (res.ok) {
                    const data = await res.json();
                    if(item) item.cantidad = data.cantidad;
                    renderizarItems();
                    actualizarResumen();
                } else {
                    const err = await res.json();
                    console.error(err);
                    mostrarNotificacion("Error al actualizar", "danger");
                    cargarCarritoDesdeAPI(); // Revertir cambios si falla
                }
            } catch(e) { 
                console.error(e);
                cargarCarritoDesdeAPI();
            }
        }

        async function eliminarItem(carritoId) {
            if(!confirm('¿Eliminar?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/carrito/${carritoId}/`, getFetchConfig('DELETE'));
                if (res.ok) {
                    cart = cart.filter(i => i.carrito_id !== carritoId);
                    renderizarItems();
                    actualizarResumen();
                }
            } catch(e) { console.error(e); }
        }

        async function vaciarCarrito(pedirConfirmacion = true) {
            if(pedirConfirmacion && !confirm('¿Vaciar todo?')) return;
            try {
                for (let item of cart) {
                    await fetch(`${API_BASE_URL}/carrito/${item.carrito_id}/`, getFetchConfig('DELETE'));
                }
                cart = [];
                renderizarItems();
                actualizarResumen();
            } catch(e) { console.error(e); }
        }

        function actualizarResumen() {
            if (cart.length === 0) {
                document.getElementById('summary-subtotal').textContent = '$0';
                document.getElementById('summary-total').textContent = '$0';
                document.getElementById('btn-pagar').disabled = true;
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => {
                const precio = item.precio || 0;
                const cant = item.cantidad || 0;
                return sum + (precio * cant);
            }, 0);

            document.getElementById('summary-subtotal').textContent = '$' + subtotal.toLocaleString('es-CL');
            document.getElementById('summary-total').textContent = '$' + subtotal.toLocaleString('es-CL');
            document.getElementById('summary-items-count').textContent = cart.reduce((acc, item) => acc + (item.cantidad || 0), 0);
            
            const puedePagar = cart.every(item => item.cantidad <= item.stock_disponible);
            const btnPagar = document.getElementById('btn-pagar');
            const terminos = document.getElementById('terminos');
            if(btnPagar) btnPagar.disabled = !(puedePagar && (terminos ? terminos.checked : false));
        }

        function verificarStockGlobal(hayError) {
            const warning = document.getElementById('stock-warning');
            if (hayError) {
                warning.classList.remove('d-none');
                document.getElementById('stock-error-details').textContent = "Algunos productos exceden el stock";
            } else {
                warning.classList.add('d-none');
            }
        }

        function setupEventListeners() {
            const terminos = document.getElementById('terminos');
            if(terminos) {
                terminos.addEventListener('change', actualizarResumen);
            }
        }

        async function procesarPago() {
            const form = document.getElementById('order-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const btn = document.getElementById('btn-pagar');
            btn.disabled = true;
            btn.innerHTML = 'Procesando...';

            const totalSeguro = cart.reduce((sum, item) => sum + ((item.precio || 0) * (item.cantidad || 0)), 0);

            const orderData = {
                nombre_cliente: document.getElementById('cliente_nombre').value,
                email_cliente: document.getElementById('cliente_email').value,
                telefono_cliente: document.getElementById('cliente_telefono').value,
                direccion_cliente: document.getElementById('cliente_direccion').value,
                total: totalSeguro,
                items: cart.map(item => ({ 
                    producto: item.producto_id, 
                    cantidad: item.cantidad, 
                    precio_unitario: item.precio 
                }))
            };

            try {
                const res = await fetch(`${API_BASE_URL}/ordenes/`, getFetchConfig('POST', orderData));
                if (res.ok) {
                    const orden = await res.json();
                    await vaciarCarrito(false); // No pedir confirmación tras compra exitosa
                    window.location.href = `/tienda/confirmacion/?id=${orden.id}`;
                } else {
                    const err = await res.json();
                    mostrarNotificacion('Error: ' + JSON.stringify(err), 'danger');
                    btn.disabled = false;
                    btn.innerHTML = 'Confirmar y Pagar';
                }
            } catch(e) {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>