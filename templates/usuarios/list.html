{% extends 'base.html' %}

{% block title %}Usuarios - TemucoSoft{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h6 class="text-uppercase text-muted small fw-bold ls-1 mb-1">Administración</h6>
        <h2 class="fw-bold text-dark"><i class="bi bi-people me-2"></i>Equipo de Trabajo</h2>
    </div>
    <div class="col-md-6">
        <div class="d-flex justify-content-md-end gap-2 mt-3 mt-md-0">
            <div class="input-group shadow-sm" style="max-width: 300px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="buscadorUsuario" class="form-control border-start-0 ps-0" placeholder="Buscar por nombre, rut o email...">
            </div>
            <a href="/usuarios/crear/" id="btn-crear-usuario" class="btn btn-primary shadow-sm px-4 text-nowrap">
                <i class="bi bi-person-plus-fill me-2"></i>Nuevo Usuario
            </a>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="usersTable">
                <thead class="bg-light border-bottom">
                    <tr>
                        <th class="ps-4 text-uppercase text-secondary x-small fw-bold opacity-7">Usuario</th>
                        <th class="text-uppercase text-secondary x-small fw-bold opacity-7">Rol & Perfil</th>
                        <th class="text-uppercase text-secondary x-small fw-bold opacity-7">Contacto</th>
                        <th class="text-uppercase text-secondary x-small fw-bold opacity-7">Organización</th>
                        <th class="text-center text-uppercase text-secondary x-small fw-bold opacity-7">Estado</th>
                        <th class="text-end pe-4 text-uppercase text-secondary x-small fw-bold opacity-7">Acción</th>
                    </tr>
                </thead>
                <tbody id="tablaUsuarios">
                    <tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary spinner-sm"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white py-3 border-top-0 d-flex justify-content-between align-items-center">
        <small class="text-muted">Total usuarios: <span id="total-count" class="fw-bold text-dark">0</span></small>
        <small class="text-muted fst-italic">Gestión de acceso y seguridad</small>
    </div>
</div>

<style>
    .ls-1 { letter-spacing: 1px; }
    .x-small { font-size: 0.7rem; }
    
    .avatar-initials {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .avatar-initials:hover {
        transform: scale(1.05);
    }

    .badge-soft-primary { background-color: #cfe2ff; color: #084298; }
    .badge-soft-success { background-color: #d1e7dd; color: #0f5132; }
    .badge-soft-warning { background-color: #fff3cd; color: #664d03; }
    .badge-soft-info    { background-color: #cff4fc; color: #055160; }
    .badge-soft-dark    { background-color: #e9ecef; color: #1f2937; }
    .badge-soft-danger  { background-color: #f8d7da; color: #842029; }

    .user-name { font-weight: 600; color: #343a40; font-size: 0.95rem; }
    .user-meta { font-size: 0.8rem; color: #6c757d; }
</style>
{% endblock %}

{% block scripts %}
<script>
    // =============================================================
    // VERIFICACIÓN DE PLAN PREMIUM (OBLIGATORIA)
    // =============================================================
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Verificar autenticación
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return;
        }

        // 2. Obtener información del usuario
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        const rol = userInfo.rol;
        const plan = userInfo.plan ? userInfo.plan.toLowerCase() : 'basico';
        
        // 3. Verificar si tiene permiso para gestionar usuarios
        // Gestión de usuarios requiere: Rol Admin + Plan Premium (o SuperAdmin)
        const isPremium = plan === 'premium';
        const isSuperAdmin = rol === 'super_admin';
        const hasUserAccess = isSuperAdmin || (rol === 'admin_cliente' && isPremium);

        // 4. Si NO tiene acceso, mostrar mensaje y bloquear
        if (!hasUserAccess) {
            document.querySelector('.main-container').innerHTML = `
                <div class="row justify-content-center mt-5">
                    <div class="col-md-8 col-lg-6">
                        <div class="card border-0 shadow-lg text-center">
                            <div class="card-body p-5">
                                <div class="icon-shape bg-success-subtle text-success rounded-circle mx-auto mb-4" style="width: 80px; height: 80px;">
                                    <i class="bi bi-people-fill fs-2"></i>
                                </div>
                                <h3 class="fw-bold text-dark mb-3">Gestión de Usuarios</h3>
                                <p class="text-muted mb-4">
                                    La gestión de múltiples usuarios requiere el <strong class="text-success">Plan Premium</strong>.
                                </p>
                                
                                <div class="alert alert-success border-0 bg-success-subtle text-start mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill fs-5 me-3 text-success"></i>
                                        <div>
                                            <strong>Tu plan actual: ${plan.toUpperCase()}</strong><br>
                                            <small class="text-muted">Con el Plan Premium puedes administrar usuarios ilimitados y gestionar permisos.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <div class="icon-shape bg-primary-subtle text-primary rounded-circle mx-auto mb-2" style="width: 50px; height: 50px;">
                                                    <i class="bi bi-person-fill fs-4"></i>
                                                </div>
                                                <h6 class="fw-bold mb-0">Plan Básico</h6>
                                                <small class="text-muted">Solo administrador</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <div class="icon-shape bg-warning-subtle text-warning rounded-circle mx-auto mb-2" style="width: 50px; height: 50px;">
                                                    <i class="bi bi-people-fill fs-4"></i>
                                                </div>
                                                <h6 class="fw-bold mb-0">Plan Estándar</h6>
                                                <small class="text-muted">Hasta 3 usuarios</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-0 bg-light h-100">
                                            <div class="card-body text-center p-3">
                                                <div class="icon-shape bg-success-subtle text-success rounded-circle mx-auto mb-2" style="width: 50px; height: 50px;">
                                                    <i class="bi bi-person-plus-fill fs-4"></i>
                                                </div>
                                                <h6 class="fw-bold mb-0">Plan Premium</h6>
                                                <small class="text-muted">Usuarios ilimitados</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-3 justify-content-center">
                                    <a href="/" class="btn btn-primary">
                                        <i class="bi bi-arrow-left me-2"></i> Volver al inicio
                                    </a>
                                    <button class="btn btn-outline-success" onclick="mostrarPlanes()">
                                        <i class="bi bi-gem me-2"></i> Actualizar a Premium
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Función para mostrar planes
            window.mostrarPlanes = function() {
                alert('Gestión de usuarios por plan:\n\n' +
                      '• BÁSICO: Solo 1 usuario administrador\n' +
                      '• ESTÁNDAR: Hasta 3 usuarios adicionales\n' +
                      '• PREMIUM: Usuarios ilimitados\n\n' +
                      'Contacta al administrador para cambiar tu plan.');
            };
            
            return; // Detener ejecución
        }

        // 5. Si SÍ tiene acceso, continuar con el código normal
        // Mostrar badge del plan en el título
        const tituloPrincipal = document.querySelector('h2');
        if (tituloPrincipal && plan !== 'basico') {
            const badgeColor = plan === 'premium' ? 'bg-success' : plan === 'estandar' ? 'bg-warning' : 'bg-primary';
            tituloPrincipal.innerHTML = `<i class="bi bi-people me-2"></i>Equipo de Trabajo <span class="badge ${badgeColor} ms-2">${plan.toUpperCase()}</span>`;
        }

        // =============================================================
        // CÓDIGO ORIGINAL PARA CARGAR USUARIOS
        // =============================================================
        let usuariosGlobal = [];

        // Ocultar botón de crear si es vendedor
        if (userInfo.rol === 'vendedor') {
            const btn = document.getElementById('btn-crear-usuario');
            if(btn) btn.style.display = 'none';
        }

        // Filtro en tiempo real
        const buscador = document.getElementById('buscadorUsuario');
        if (buscador) {
            buscador.addEventListener('input', function(e) {
                const texto = e.target.value.toLowerCase();
                const filtrados = usuariosGlobal.filter(u => 
                    u.username.toLowerCase().includes(texto) || 
                    u.email.toLowerCase().includes(texto) ||
                    (u.rut && u.rut.toLowerCase().includes(texto))
                );
                renderizarTabla(filtrados);
            });
        }

        cargarUsuarios();
    });

    async function cargarUsuarios() {
        const tbody = document.getElementById('tablaUsuarios');
        const totalCountElement = document.getElementById('total-count'); 
        
        if (!tbody) return; 

        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary spinner-sm"></div></td></tr>';
        if (totalCountElement) totalCountElement.textContent = '...';

        try {
            const response = await fetch('/api/usuarios/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.status === 403) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="text-muted opacity-50 mb-2"><i class="bi bi-shield-lock-fill display-4"></i></div>
                            <h6 class="text-danger">Acceso Restringido</h6>
                            <p class="small text-muted">No tienes permisos para ver esta lista.</p>
                        </td>
                    </tr>`;
                const btn = document.getElementById('btn-crear-usuario');
                if(btn) btn.style.display = 'none';
                if (totalCountElement) totalCountElement.textContent = '0';
                return;
            }

            if (!response.ok) throw new Error('Error al cargar datos');

            const data = await response.json();
            usuariosGlobal = data.results || data;

            renderizarTabla(usuariosGlobal);

        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger py-5">
                        Error de conexión. Intente recargar.
                    </td>
                </tr>`;
            if (totalCountElement) totalCountElement.textContent = '0';
        }
    }

    function renderizarTabla(usuarios) {
        const tbody = document.getElementById('tablaUsuarios');
        const totalCountElement = document.getElementById('total-count');
        
        if (!tbody) return; 
        
        tbody.innerHTML = '';
        
        if (usuarios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="bi bi-people display-4 opacity-25"></i>
                        <p class="mt-3">No se encontraron usuarios.</p>
                    </td>
                </tr>`;
            if (totalCountElement) totalCountElement.textContent = '0';
            return;
        }
        
        usuarios.forEach(usuario => {
            // Manejo seguro del nombre de compañía (USA EL CAMPO compania_nombre de la API)
            let companiaDisplay = usuario.compania_nombre || 'Staff Global';
            let companiaIcon = 'bi-globe';
            
            if (companiaDisplay !== 'Staff Global') {
                 companiaIcon = 'bi-building';
            }


            const rolStyle = obtenerEstiloRol(usuario.rol);

            const statusHtml = usuario.is_active 
                ? `<span class="badge badge-soft-success border border-success-subtle rounded-pill"><i class="bi bi-dot"></i> Activo</span>`
                : `<span class="badge badge-soft-danger border border-danger-subtle rounded-pill">Inactivo</span>`;

            const inicial = usuario.username.charAt(0).toUpperCase();

            const row = `
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="avatar-initials ${rolStyle.bgSoft} ${rolStyle.text} me-3">
                                ${inicial}
                            </div>
                            <div>
                                <div class="user-name">${usuario.username}</div>
                                <div class="user-meta">RUT: ${usuario.rut || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${rolStyle.badge} border border-0 rounded-1 px-2 py-1 text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px;">
                            ${formatRol(usuario.rol)}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <a href="mailto:${usuario.email}" class="text-decoration-none text-dark small mb-1">
                                <i class="bi bi-envelope me-1 text-muted"></i> ${usuario.email}
                            </a>
                            <span class="user-meta">
                                <i class="bi bi-telephone me-1"></i> ${usuario.telefono || '-'}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center text-secondary small">
                            <i class="bi ${companiaIcon} me-2 opacity-50"></i> 
                            <span class="text-dark fw-medium">${companiaDisplay}</span>
                        </div>
                    </td>
                    <td class="text-center">${statusHtml}</td>
                    <td class="text-end pe-4">
                        <a href="/usuarios/${usuario.id}/" class="btn btn-icon btn-sm btn-light text-primary border shadow-sm" title="Ver Perfil">
                            <i class="bi bi-eye-fill"></i>
                        </a>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        if (totalCountElement) totalCountElement.textContent = usuarios.length;
    }

    function obtenerEstiloRol(rol) {
        switch(rol) {
            case 'super_admin': return { bgSoft: 'bg-dark', text: 'text-white', badge: 'bg-dark' };
            case 'admin_cliente': return { bgSoft: 'bg-primary-subtle', text: 'text-primary', badge: 'bg-primary' };
            case 'gerente': return { bgSoft: 'bg-info-subtle', text: 'text-info-emphasis', badge: 'bg-info text-dark' };
            case 'vendedor': return { bgSoft: 'bg-success-subtle', text: 'text-success', badge: 'bg-success' };
            default: return { bgSoft: 'bg-secondary-subtle', text: 'text-secondary', badge: 'bg-secondary' };
        }
    }

    function formatRol(rol) {
        return rol.replace('_', ' ');
    }
</script>
{% endblock %}