{% extends 'base.html' %}

{% block title %}Crear Usuario - TemucoSoft{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">Nuevo Usuario</h2>
        <a href="/usuarios/" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left me-2"></i>Volver
        </a>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <form id="crearUsuarioForm">
                <div class="row g-3">
                    <div class="col-12"><h6 class="text-muted border-bottom pb-2">Datos de Cuenta</h6></div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Nombre de Usuario <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="username" required placeholder="Ej: j.perez">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" name="email" required placeholder="juan@empresa.com">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Contraseña <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" name="password" required placeholder="••••••••">
                    </div>
                    
                    <div class="col-12 mt-4"><h6 class="text-muted border-bottom pb-2">Información Personal</h6></div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">RUT <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="rut" required placeholder="12.345.678-9">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Teléfono</label>
                        <input type="tel" class="form-control" name="telefono" placeholder="+56 9 ...">
                    </div>

                    <div class="col-12 mt-4"><h6 class="text-muted border-bottom pb-2">Asignación</h6></div>

                    <div class="col-md-12 mb-3" id="container-compania" style="display: none;">
                        <label class="form-label fw-bold small text-primary">Compañía (Solo Super Admin) <span class="text-danger">*</span></label>
                        <select class="form-select border-primary" name="compania" id="select-compania">
                            <option value="">Seleccione una compañía...</option>
                            </select>
                        <div class="form-text">Asigna este usuario a una empresa cliente.</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">Rol <span class="text-danger">*</span></label>
                        <select class="form-select" name="rol" id="select-rol" required onchange="toggleSucursal()">
                            <option value="vendedor">Vendedor</option>
                            <option value="gerente">Gerente</option>
                            <option value="admin_cliente">Administrador Cliente</option>
                            <option value="super_admin" class="opcion-super">Super Admin</option>
                        </select>
                    </div>

                    <div class="col-md-6" id="container-sucursal">
                        <label class="form-label fw-bold small text-secondary">Sucursal Asignada <span class="text-danger">*</span></label>
                        <select class="form-select" name="sucursal" id="select-sucursal">
                            <option value="">Seleccione una sucursal...</option>
                        </select>
                    </div>
                </div>

                <div class="mt-5 d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-light text-secondary" onclick="window.location.href='/usuarios/'">Cancelar</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">
                        <i class="bi bi-person-plus-fill me-2"></i>Crear Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Helpers
    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getFetchConfig(method = 'GET', bodyData = null) {
        const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
        const token = localStorage.getItem('access_token');
        if (token) headers['Authorization'] = `Bearer ${token}`;
        else { const csrf = getCSRFToken(); if (csrf) headers['X-CSRFToken'] = csrf; }
        
        const config = { method, headers, credentials: 'include' };
        if (bodyData) config.body = JSON.stringify(bodyData);
        return config;
    }

    // 2. Variables Globales
    let esSuperAdmin = false;

    document.addEventListener('DOMContentLoaded', async () => {
        // Verificar quién soy
        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
        esSuperAdmin = userInfo.rol === 'super_admin';

        // Lógica Super Admin
        if (esSuperAdmin) {
            document.getElementById('container-compania').style.display = 'block';
            await cargarCompanias();
        } else {
            // Ocultar opción de crear otro super admin si no eres uno
            document.querySelectorAll('.opcion-super').forEach(el => el.remove());
        }

        await cargarSucursales();
        toggleSucursal(); 
    });

    async function cargarCompanias() {
        try {
            const res = await fetch('/api/companias/', getFetchConfig());
            if (res.ok) {
                const data = await res.json();
                const lista = data.results || data;
                const select = document.getElementById('select-compania');
                lista.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.nombre;
                    select.appendChild(opt);
                });
            }
        } catch(e) { console.error(e); }
    }

    async function cargarSucursales() {
        try {
            const res = await fetch('/api/sucursales/', getFetchConfig());
            if (res.ok) {
                const data = await res.json();
                const sucursales = data.results || data;
                const select = document.getElementById('select-sucursal');
                sucursales.forEach(suc => {
                    const option = document.createElement('option');
                    option.value = suc.id;
                    option.textContent = suc.nombre;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }

    window.toggleSucursal = function() {
        const rol = document.getElementById('select-rol').value;
        const select = document.getElementById('select-sucursal');
        
        // Si es Admin Cliente o Super Admin, sucursal es opcional
        if (rol === 'admin_cliente' || rol === 'super_admin') {
            select.required = false; 
        } else {
            select.required = true;
        }
    }

    document.getElementById('crearUsuarioForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Guardando...';

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        // Limpieza de campos vacíos
        if (!data.sucursal) delete data.sucursal;
        if (!data.compania) delete data.compania; // Borrar si viene vacío

        try {
            const res = await fetch('/api/usuarios/', getFetchConfig('POST', data));
            if (res.ok) {
                alert('¡Usuario creado exitosamente!');
                window.location.href = '/usuarios/';
            } else {
                const errorData = await res.json();
                let msg = JSON.stringify(errorData);
                if(errorData.detail) msg = errorData.detail;
                alert('Error: ' + msg);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            alert('Error de conexión');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
{% endblock %}